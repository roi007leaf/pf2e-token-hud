(()=>{var kt=Object.defineProperty;var Oi=(t,e,n)=>e in t?kt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var u=(t,e)=>kt(t,"name",{value:e,configurable:!0});var Te=(t,e,n)=>(Oi(t,typeof e!="symbol"?e+"":e,n),n),Li=(t,e,n)=>{if(!e.has(t))throw TypeError("Cannot "+n)};var Ie=(t,e,n)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,n)};var X=(t,e,n)=>(Li(t,e,"access private method"),n);var Pi="Compendium.pf2e.feats-srd.Item.jFmdevE4nKevovzo";async function bt(t){function e(d){ChatMessage.create({user:game.user.id,content:d,speaker:ChatMessage.getSpeaker({actor:t})})}u(e,"toChat");let{name:n,attributes:i,system:s}=t,a=i.hp.sp,r=s.resources.resolve,c=C("hud.resolve.full",{name:n}),o=game.i18n.format("PF2E.Actions.SteelYourResolve.NoStamina",{name:n});if(a.value===a.max)return ui.notifications.warn(c);if(r.value<1)return ui.notifications.warn(o);let l=t.itemTypes.feat.find(d=>d.sourceId===Pi),f=await renderTemplate(N("dialogs/resolve"),{hasSteel:l,i18n:d=>C(`hud.resolve.${d}`)});new Dialog({title:C("hud.resolve.title"),content:f,buttons:{yes:{icon:"<i class='fas fa-check'></i>",label:C("hud.resolve.yes"),callback:async d=>{let{attributes:p,system:g}=t,h=p.hp.sp,m=g.resources.resolve;if(h.value===h.max)return e(c);if(m.value<1)return e(o);let b=d.find("input:checked").val(),w=`${h.value}/${h.max}`;if(b==="breather")e(C("hud.resolve.breather.used",{name:n,ratio:w})),await t.update({"system.attributes.hp.sp.value":h.max,"system.resources.resolve.value":m.value-1});else{e(game.i18n.format("PF2E.Actions.SteelYourResolve.RecoverStamina",{name:n,ratio:w}));let I=h.value+Math.floor(h.max/2);await t.update({"system.attributes.hp.sp.value":Math.min(I,h.max),"system.resources.resolve.value":m.value-1})}}},no:{icon:"<i class='fas fa-times'></i>",label:C("hud.resolve.no")}}}).render(!0)}u(bt,"useResolve");function wt(){return CONFIG.Dice.rolls.find(t=>t.name==="DamageRoll")}u(wt,"getDamageRollClass");var Fi=function(t,e,n){if(n||arguments.length===2)for(var i=0,s=e.length,a;i<s;i++)(a||!(i in e))&&(a||(a=Array.prototype.slice.call(e,0,i)),a[i]=e[i]);return t.concat(a||Array.prototype.slice.call(e))};function vt(t,e,n){var i=t.length-e.length,s=Array.from(e);if(i===0)return t.apply(void 0,s);if(i===1){var a=u(function(r){return t.apply(void 0,Fi([r],s,!1))},"ret");return(n||t.lazy)&&(a.lazy=n||t.lazy,a.lazyArgs=e),a}throw new Error("Wrong number of arguments")}u(vt,"purry");function Me(t){for(var e={},n=0,i=t;n<i.length;n++){var s=i[n],a=s[0],r=s[1];e[a]=r}return e}u(Me,"fromPairs");(function(t){t.strict=t})(Me||(Me={}));function Tt(t){return Array.isArray(t)}u(Tt,"isArray");function It(t){return!!t&&!Array.isArray(t)&&typeof t=="object"}u(It,"isObject");function St(t){return typeof t=="string"}u(St,"isString");function Ct(t){return t===void 0?!0:Tt(t)||St(t)?t.length===0:It(t)?Object.keys(t).length===0:!1}u(Ct,"isEmpty");var Re=function(){return Re=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++){e=arguments[n];for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s])}return t},Re.apply(this,arguments)},Mi=function(t,e){var n={};for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.indexOf(i)<0&&(n[i]=t[i]);if(t!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,i=Object.getOwnPropertySymbols(t);s<i.length;s++)e.indexOf(i[s])<0&&Object.prototype.propertyIsEnumerable.call(t,i[s])&&(n[i[s]]=t[i[s]]);return n};function Et(){return vt(Ri,arguments)}u(Et,"omit");function Ri(t,e){if(e.length===0)return Re({},t);if(e.length===1){var n=e[0],i=t,s=n,a=i[s],r=Mi(i,[typeof s=="symbol"?s:s+""]);return r}if(!e.some(function(o){return o in t}))return Re({},t);var c=new Set(e);return Me(Object.entries(t).filter(function(o){var l=o[0];return!c.has(l)}))}u(Ri,"_omit");var Ni=new Map([["incredibly-easy",-10],["very-easy",-5],["easy",-2],["normal",0],["hard",2],["very-hard",5],["incredibly-hard",10]]),$i=new Map([[-1,13],[0,14],[1,15],[2,16],[3,18],[4,19],[5,20],[6,22],[7,23],[8,24],[9,26],[10,27],[11,28],[12,30],[13,31],[14,32],[15,34],[16,35],[17,36],[18,38],[19,39],[20,40],[21,42],[22,44],[23,46],[24,48],[25,50]]);function Ui(t,e="normal"){return t+(Ni.get(e)??0)}u(Ui,"adjustDC");function ji(t="common"){switch(t){case"uncommon":return"hard";case"rare":return"very-hard";case"unique":return"incredibly-hard";default:return"normal"}}u(ji,"rarityToDCAdjustment");function Ne(t,e="common"){return Ui(t,ji(e))}u(Ne,"adjustDCByRarity");function $e(t,{pwol:e,rarity:n="common"}={}){e??=game.pf2e.settings.variants.pwol.enabled;let i=$i.get(t)??14;return Ne(e?i-Math.max(t,0):i,n)}u($e,"calculateDC");function Se(t,e){return t instanceof Element||t instanceof Document?Array.from(t.querySelectorAll(e)):[]}u(Se,"htmlQueryAll");function ye(t,e){return t instanceof Element?t.closest(e):null}u(ye,"htmlClosest");function Dt(t,{classes:e=[],dataset:n={},children:i=[],innerHTML:s}={}){let a=document.createElement(t);e.length>0&&a.classList.add(...e);for(let[r,c]of Object.entries(n).filter(([,o])=>!R.isNil(o)))a.dataset[r]=String(c);if(s)a.innerHTML=s;else for(let r of i){let c=r instanceof HTMLElement?r:new Text(r);a.appendChild(c)}return a}u(Dt,"createHTMLElement");var At={0:"systems/pf2e/icons/actions/FreeAction.webp",free:"systems/pf2e/icons/actions/FreeAction.webp",1:"systems/pf2e/icons/actions/OneAction.webp",2:"systems/pf2e/icons/actions/TwoActions.webp",3:"systems/pf2e/icons/actions/ThreeActions.webp","1 or 2":"systems/pf2e/icons/actions/OneTwoActions.webp","1 to 3":"systems/pf2e/icons/actions/OneThreeActions.webp","2 or 3":"systems/pf2e/icons/actions/TwoThreeActions.webp",reaction:"systems/pf2e/icons/actions/Reaction.webp",passive:"systems/pf2e/icons/actions/Passive.webp"},Hi={0:"F",free:"F",1:"A",2:"D",3:"T","1 or 2":"A/D","1 to 3":"A - T","2 or 3":"D/T",reaction:"R"};function xt(t,e="systems/pf2e/icons/actions/Empty.webp"){if(t===null)return At.passive;let n=typeof t!="object"?t:t.type==="action"?t.value:t.type,i=String(n??"").toLowerCase().trim();return At[i]??e}u(xt,"getActionIcon");function Ue(t){if(!t&&t!==0)return"";let e=typeof t!="object"?t:t.type==="action"?t.value:t.type,n=String(e??"").toLowerCase().trim();return Hi[n]??""}u(Ue,"getActionGlyph");function Ce(t){return Error(`PF2e System | ${t}`)}u(Ce,"ErrorPF2e");function Ot(t,e){return t.includes(e)}u(Ot,"tupleHasValue");function je(t,e){return(typeof e=="string"||typeof e=="number")&&e in t}u(je,"objectHasKey");function ke(t,e){return game.pf2e.system.sluggify(t,e)}u(ke,"sluggify");function Lt(t,e){return t.has(e)}u(Lt,"setHasElement");function Pt(t,e){let n={name:t,label:game.i18n.localize(e[t]??t)};return je(CONFIG.PF2E.traitsDescriptions,t)&&(n.description=CONFIG.PF2E.traitsDescriptions[t]),n}u(Pt,"traitSlugToObject");function Ft(t){let e=new Intl.PluralRules(game.i18n.lang,{type:"ordinal"}),n=game.i18n.localize(`PF2E.OrdinalSuffixes.${e.select(t)}`);return game.i18n.format("PF2E.OrdinalNumber",{value:t,suffix:n})}u(Ft,"ordinalString");function Mt(t){if(t==="cantrips")return 0;let e=Number(t??NaN);return e.between(0,10)?e:null}u(Mt,"spellSlotGroupIdToNumber");function Rt(t){if(t==="cantrips")return t;let e=Number(t)||NaN;return e.between(1,10)?e:null}u(Rt,"coerceToSpellGroupId");function Nt(t){return(...[e,n])=>n?game.i18n.format(`${t}.${e}`,n):game.i18n.localize(`${t}.${e}`)}u(Nt,"localizer");function $t(t){return!!t&&"ctrlKey"in t&&"metaKey"in t&&"shiftKey"in t}u($t,"isRelevantEvent");function He(t,e){let n=e.type==="check"?"showCheckDialogs":"showDamageDialogs",i=!game.user.settings[n];if(!$t(t))return{skipDialog:i};let s={skipDialog:t.shiftKey?!i:i};return(t.ctrlKey||t.metaKey)&&(s.rollMode=game.user.isGM?"gmroll":"blindroll"),s}u(He,"eventToRollParams");function _e(t){return!$t(t)||!(t.ctrlKey||t.metaKey)?"roll":game.user.isGM?"gmroll":"blindroll"}u(_e,"eventToRollMode");var zi=["fortitude","reflex","will"],Ut=["action","check","effect-area"].map(t=>`[data-pf2-${t}]`).join(","),ee={injectRepostElement:(t,e)=>{for(let n of t){(!e||e.isOwner)&&n.classList.add("with-repost");let i=Se(n,"i[data-pf2-repost]");if(i.length>0){if(e&&!e.isOwner){for(let r of i)r.remove();n.classList.remove("with-repost")}continue}if(e&&!e.isOwner)continue;let s=document.createElement("i"),a=n.parentElement?.dataset?.pf2Checkgroup!==void 0?"fa-comment-alt-dots":"fa-comment-alt";s.classList.add("fa-solid",a),s.dataset.pf2Repost="",s.title=game.i18n.localize("PF2E.Repost"),n.appendChild(s),s.addEventListener("click",r=>{r.stopPropagation();let c=r.target;if(!(c instanceof HTMLElement))return;let o=c?.parentElement;if(!o)return;let l=jt(c,e);ee.repostAction(o,l)})}},listen:(t,e=null)=>{let n=e??jt(t,e),i=Se(t,Ut).filter(a=>["A","SPAN"].includes(a.nodeName));ee.injectRepostElement(i,n),ee.flavorDamageRolls(t,n instanceof Actor?n:null);for(let a of i.filter(r=>r.dataset.pf2Action)){let{pf2Action:r,pf2Glyph:c,pf2Variant:o,pf2Dc:l,pf2ShowDc:f,pf2Skill:d}=a.dataset;a.addEventListener("click",p=>{let g=ke(r??""),h=f??"all",m=Number.isNumeric(l)?{scope:"check",value:Number(l)||0,visibility:h}:l;if(g&&game.pf2e.actions.has(g))game.pf2e.actions.get(g)?.use({event:p,variant:o,difficultyClass:m,statistic:d}).catch(b=>ui.notifications.warn(b));else{let b=game.pf2e.actions[r?ke(r,{camel:"dromedary"}):""];r&&b?b({event:p,glyph:c,variant:o,difficultyClass:m,skill:d}):console.warn(`PF2e System | Skip executing unknown action '${r}'`)}})}for(let a of i.filter(r=>r.dataset.pf2Check&&!r.dataset.invalid)){let{pf2Check:r,pf2Dc:c,pf2Traits:o,pf2Label:l,pf2Defense:f,pf2Adjustment:d,pf2Roller:p,pf2RollOptions:g,overrideTraits:h}=a.dataset;if(!r)return;a.addEventListener("click",async m=>{let b=at(n,a),w=[b];if(w.length===0){ui.notifications.error("PF2E.ErrorMessage.NoTokenSelected",{localize:!0});return}let I=[...o?.split(",").map(x=>x.trim())??[],...g?.split(",").map(x=>x.trim())??[]],D=He(m,{type:"check"}),U=a.dataset.slug?ke(a.dataset.slug):null;switch(r){case"flat":{for(let x of w){let Y=new x.saves.reflex.constructor(x,{label:"",slug:"flat",modifiers:[],check:{type:"flat-check"}}),H=Number.isInteger(Number(c))?{label:l,value:Number(c)}:null;Y.roll({...D,slug:U,extraRollOptions:I,dc:H})}break}default:{let x=Ot(zi,r),Y=x?[]:I.filter(H=>H in CONFIG.PF2E.actionTraits)??[];for(let H of w){let _=(()=>{if(r in CONFIG.PF2E.magicTraditions){let M=H.spellcasting.filter(z=>z.tradition===r).flatMap(z=>z.statistic??[]).sort((z,ge)=>ge.check.mod-z.check.mod).shift()??null;if(M)return M}return H.getStatistic(r)})();if(!_){console.warn(Ce(`Skip rolling unknown statistic ${r}`).message);continue}let F=f?game.user.targets.first()?.actor:null,E=(()=>{let M=Number(d)||0;return c==="@self.level"?$e(H.level)+M:Number(c??"NaN")+M})(),q=(()=>{if(Number.isInteger(E))return{label:l,value:E};if(f){let M=F?.getStatistic(f);return M?{statistic:M.dc,scope:"check",value:M.dc.value}:null}return null})(),L=(()=>{let M=n instanceof Item?n:n instanceof ChatMessage?n.item:null;return M?.isOfType("action","feat","campaignFeature")||x&&!M?.isOfType("weapon")?M:null})(),V={...D,extraRollOptions:I,origin:x&&b instanceof Actor?b:null,dc:q,target:!x&&q?.statistic?F:null,item:L,traits:Y};if(!h&&!!(L?.isOfType("action","feat")&&L.actionCost)&&!["flat-check","saving-throw"].includes(_.check.type)){let M=r in CONFIG.PF2E.magicTraditions?"PF2E.ActionsCheck.spell":_.check.type==="attack-roll"?"PF2E.ActionsCheck.x-attack-roll":"PF2E.ActionsCheck.x";V.label=await renderTemplate("systems/pf2e/templates/chat/action/header.hbs",{glyph:Ue(L.actionCost),subtitle:game.i18n.format(M,{type:_.label}),title:L.name}),I.push(...TextEditorPF2e.createActionOptions(L))}_.roll(V)}}}})}let s={burst:"circle",cone:"cone",cube:"rect",emanation:"circle",line:"ray",rect:"rect",square:"rect"};for(let a of i.filter(r=>r.hasAttribute("data-pf2-effect-area"))){let{pf2EffectArea:r,pf2Distance:c,pf2TemplateData:o,pf2Traits:l,pf2Width:f}=a.dataset;a.addEventListener("click",()=>{if(!canvas.ready)return;if(typeof r!="string"){console.warn("PF2e System | Could not create template'");return}let d=JSON.parse(o??"{}");switch(d.distance||=Number(c),d.fillColor||=game.user.color,d.t=s[r],d.t){case"ray":d.width=Number(f)||CONFIG.MeasuredTemplate.defaults.width*canvas.dimensions.distance;break;case"cone":d.angle||=CONFIG.MeasuredTemplate.defaults.angle;break;case"rect":{let m=d.distance??0;d.distance=Math.hypot(m,m),d.width=m,d.direction=45;break}}let p={pf2e:{}};je(CONFIG.PF2E.areaTypes,r)&&je(CONFIG.PF2E.areaSizes,d.distance)&&(p.pf2e.areaType=r);let g=n instanceof ChatMessage?n.id:ye(t,"[data-message-id]")?.dataset.messageId??null;g&&(p.pf2e.messageId=g);let h=at(n,a);if(h||l){let m={};h&&(m.actor=h.uuid),l&&(m.traits=l.split(",")),p.pf2e.origin=m}Ct(p.pf2e)||(d.flags=p),canvas.templates.createPreview(d)})}for(let a of t.querySelectorAll("a[data-damage-roll]"))a.dataset.itemUuid=n.uuid},makeRepostHtml:(t,e)=>{let n=game.i18n.localize(t.dataset.pf2RepostFlavor??"");return`<span data-visibility="${t.dataset.pf2ShowDc??e}">${n}</span> ${t.outerHTML}`.trim()},repostAction:(t,e=null)=>{if(!["pf2Action","pf2Check","pf2EffectArea"].some(l=>l in t.dataset))return;let n=at(e,t),i=(n??e)?.hasPlayerOwner?"all":"gm",s=(()=>t.parentElement?.dataset?.pf2Checkgroup!==void 0?`<div data-pf2-checkgroup>${Se(t.parentElement,Ut).map(f=>ee.makeRepostHtml(f,i)).join("<br>")}</div>`:ee.makeRepostHtml(t,i))(),a=ChatMessage.implementation,r=n?a.getSpeaker({actor:n,token:n.getActiveTokens(!1,!0).shift()}):a.getSpeaker(),c=game.messages.get(ye(t,"[data-message-id]")?.dataset.messageId??""),o=e instanceof JournalEntry?{pf2e:{journalEntry:e.uuid}}:c?.flags.pf2e.origin?{pf2e:{origin:fu.deepClone(c.flags.pf2e.origin)}}:{};a.create({speaker:r,content:s,flags:o})},flavorDamageRolls(t,e=null){for(let n of Se(t,"a.inline-roll[data-damage-roll]")){let i=ye(n,"[data-item-id]")?.dataset.itemId,s=e?.items.get(i??"");s&&(n.dataset.flavor||=s.name)}}};function jt(t,e){if(e)return e;let i=(ui.windows[Number(t.closest(".app.sheet")?.dataset.appid)]??null)?.document;return i instanceof Actor||i instanceof JournalEntry?i:null}u(jt,"resolveDocument");function at(t,e){if(t instanceof Actor)return t;if(t instanceof Item||t instanceof ChatMessage)return t.actor;let n=e.dataset.itemUuid,i=n&&!n.startsWith("Compendium.")?fromUuidSync(n):null;return i instanceof Item?i.actor:null}u(at,"resolveActor");var ze=["U","T","E","M","L"],Bi="Compendium.pf2e.other-effects.Item.I9lfZUiCwMiGogVi";async function Ht(t,e){let n=t.data(),i=n.itemId?_t(t[0],e):await fromUuid(n.uuid),s=await i?.getChatData({secrets:e.isOwner},n);if(!s)return;let a=document.createElement("div");return a.classList.add("description"),await e.sheet.itemRenderer.renderItemSummary(a,i,s),ee.listen(a,i),n.castRank&&(a.dataset.castRank=n.castRank),a}u(Ht,"getItemSummary");function J(t){let e=t.find(".name");e.on("mouseenter",n=>{n.preventDefault();let i=n.currentTarget,{width:s}=i.getBoundingClientRect();if(i.scrollWidth<=Math.ceil(s))return;let a=i.innerHTML.trim();game.tooltip.activate(n.currentTarget,{text:a,direction:TooltipManager.TOOLTIP_DIRECTIONS.UP})}),e.on("mouseleave",n=>{n.preventDefault(),game.tooltip.deactivate()}),e.on("mousedown",n=>{game.tooltip.deactivate()})}u(J,"addNameTooltipListeners");function _t(t,e){let{itemId:n,parentId:i,entryId:s,castRank:a}=t.dataset;if(s)return e.spellcasting.collections.get(s)?.get(n);let r=e.items.get(i??n);return i?r?.subitems.get(n):r}u(_t,"getItemFromElement");function B(t,e){let n=t.currentTarget.closest("[data-item-id]");return _t(n,e)}u(B,"getItemFromEvent");function Be(t){return t.isOwner?te(t,`macros.${game.user.id}`)?.map(e=>{let n=fromUuidSync(e);return n?{img:n.img,name:n.name,uuid:e}:null}).filter(Boolean):void 0}u(Be,"getMacros");function Ge(t,e){let{type:n,uuid:i}=TextEditor.getDragEventData(t.originalEvent)??{};if(n!=="Macro"||!fromUuidSync(i))return;let s=`macros.${game.user.id}`,a=te(e,s)?.slice()??[];a.includes(i)||(a.push(i),le(e,s,a))}u(Ge,"onDroppedMacro");function qe(t,e){let n=`macros.${game.user.id}`,i=te(e,n)?.slice();if(!i?.length)return;let{uuid:s}=t.currentTarget.closest(".macro").dataset,a=i.indexOf(s);a!==-1&&(i.splice(a,1),le(e,n,i))}u(qe,"deleteMacro");function Ke(t=()=>!0){let e=game.user.targets,n=e.size===1?e.first():null;return n&&t(n)?n:null}u(Ke,"getUniqueTarget");function G(t,e){return e?t.toLowerCase().includes(e):!0}u(G,"filterIn");function j(t,e){return t.localeCompare(e,game.i18n.lang)}u(j,"localeCompare");function ot(t){return t?.itemTypes.effect.find(e=>e.flags.core?.sourceId===Bi)}u(ot,"getCoverEffect");async function ue(t,e,n){let i=ie(),s=i?.element;if(!s)return;s.find("> .popup").remove();let a=document.createElement("div");a.innerHTML=`<div class="popup">
    <div class="header">
        <div class="title">${t}</div>
        <a class="observable" data-action="close-popup"><i class="fas fa-times"></i> ${C("popup.close")}</a>
    </div>
</div>`;let r=a.firstElementChild;if(typeof e=="string"){let o=await re(e,n);r.insertAdjacentHTML("beforeend",o)}else r.append(e);r.querySelector("[data-action=close-popup]").addEventListener("click",()=>r.remove());let c=r.querySelectorAll("[data-action='consume']");for(let o of c)o.addEventListener("click",()=>r.remove());s.append(r),i.lock()}u(ue,"popup");async function W(t,e,n){let i=await Ht(t,e);if(i){let s=n??t.find(".name").html();ue(s.trim(),i,e)}}u(W,"showItemSummary");async function We(t,e,n,i){let s=ChatMessage.implementation,r=`systems/pf2e/templates/chat/${ke(e.type)}-card.hbs`,c=n.token,o=ye(t?.target,".item"),l=i.data??{...o?.dataset??{}},f={actor:n,tokenId:c?`${c.parent?.id}.${c.id}`:null,item:e,data:await e.getChatData(void 0,l)},d=t instanceof MouseEvent?t:t?.originalEvent,p=i.rollMode??_e(d),g=s.applyRollMode({type:CONST.CHAT_MESSAGE_TYPES.OTHER,speaker:s.getSpeaker({actor:n,token:n.getActiveTokens(!1,!0).at(0)}),content:await renderTemplate(r,f),flags:{pf2e:{origin:e.getOriginData()}}},p);return i.create??!0?s.create(g,{rollMode:p,renderSheet:!1}):new s(g,{rollMode:p})}u(We,"unownedItemToMessage");async function zt(t,e="roll"){if(!t.system.selfEffect)throw Ce(["Only actions with self-applied effects can be passed to `ActorPF2e#useAction`.","Support will be expanded at a later time."].join(" "));let{actor:n,actionCost:i}=t,s=n.getActiveTokens(!0,!0).shift()??null,a=ChatMessage.implementation,r=a.getSpeaker({actor:n,token:s}),c=await renderTemplate("systems/pf2e/templates/chat/action/flavor.hbs",{action:{title:t.name,glyph:Ue(i)},item:t,traits:t.system.traits.value.map(h=>Pt(h,CONFIG.PF2E.actionTraits))}),o=100,l=(()=>{if(t.actor.pack)return null;let h=document.createElement("div"),m=[...CONST.DOCUMENT_LINK_TYPES,"Compendium","UUID"],b=new RegExp(`@(${m.join("|")})\\[([^#\\]]+)(?:#([^\\]]+))?](?:{([^}]+)})?`,"g");return h.innerHTML=t.description.replace(b,(w,...I)=>I[3]),h.innerText.slice(0,o)})(),f={full:l&&l.length<o?t.description:null,preview:l},d=await renderTemplate("systems/pf2e/templates/chat/action/self-effect.hbs",{actor:t.actor,description:f}),p={pf2e:{context:{type:"self-effect",item:t.id}}},g=a.applyRollMode({speaker:r,flavor:c,content:d,flags:p},e);return a.create(g)}u(zt,"createSelfEffectMessage");async function Bt(t,e){let n=t.parentItem;if(!n)throw Ce("Subitem has no parent item");let i=Nt("PF2E.Item.Physical.Attach.Detach");if(!(e||await Dialog.confirm({title:i("Label"),content:Dt("p",{children:[i("Prompt",{attachable:t.name})]}).outerHTML})))return;let a=t.delete(),r=(async()=>{let c=n.actor?.inventory.findStackableItem(t.clone({"system.equipped.carryType":"worn"}));return c?.update({"system.quantity":c.quantity+1})??Item.implementation.create(mergeObject(t.toObject(),{_id:null,"system.containerId":n.system.containerId}),{parent:n.actor})})();await Promise.all([a,r])}u(Bt,"detachSubitem");async function Gt({weapon:t,trait:e,selection:n}){if(t.system.traits.toggles[e].selection===n)return!1;let s=t.actor?.items.get(t.id);return s?.isOfType("weapon")&&s===t?await s.update({[`system.traits.toggles.${e}.selection`]:n}):s?.isOfType("weapon")&&t.altUsageType==="melee"?s.update({[`system.meleeUsage.traitToggles.${e}`]:n}):e==="versatile"&&s?.isOfType("shield")?s.update({"system.traits.integrated.versatile.selection":n}):await s?.rules.find(r=>r.key==="Strike"&&!r.ignored&&r.slug===t.slug)?.toggleTrait({trait:e,selection:n}),!0}u(Gt,"toggleWeaponTrait");var Qe,Kt,be,Ye,de,Ee,Xe,Wt,ce=class{constructor(e,n,i=null){Ie(this,Qe);Ie(this,be);Ie(this,de);Ie(this,Xe);e instanceof Roll?(this.dieResult=(e.isDeterministic?e.terms.find(s=>s instanceof NumericTerm):e.dice.find(s=>s instanceof Die&&s.faces===20))?.total??1,this.rollTotal=e.total):(this.dieResult=e.dieValue,this.rollTotal=e.dieValue+e.modifier),this.dc=typeof n=="number"?{value:n}:n,this.unadjusted=X(this,Xe,Wt).call(this),this.adjustment=X(this,Qe,Kt).call(this,this.unadjusted,i),this.value=this.adjustment?X(this,be,Ye).call(this,this.adjustment.amount,this.unadjusted):this.unadjusted}},ne=ce;u(ne,"DegreeOfSuccess"),Qe=new WeakSet,Kt=u(function(e,n){if(!n)return null;for(let i of["all",...qt]){let{label:s,amount:a}=n[i]??{};if(a&&s&&!(e===ce.CRITICAL_SUCCESS&&a===Ve.INCREASE)&&!(e===ce.CRITICAL_FAILURE&&a===Ve.LOWER)&&(i==="all"||qt.indexOf(i)===e))return{label:s,amount:a}}return null},"#getDegreeAdjustment"),be=new WeakSet,Ye=u(function(e,n){switch(e){case"criticalFailure":return 0;case"failure":return 1;case"success":return 2;case"criticalSuccess":return 3;default:return Math.clamped(n+e,0,3)}},"#adjustDegreeOfSuccess"),de=new WeakSet,Ee=u(function(e){return this.dieResult===20?X(this,be,Ye).call(this,Ve.INCREASE,e):this.dieResult===1?X(this,be,Ye).call(this,Ve.LOWER,e):e},"#adjustDegreeByDieValue"),Xe=new WeakSet,Wt=u(function(){let e=this.dc.value;return this.rollTotal-e>=10?X(this,de,Ee).call(this,ce.CRITICAL_SUCCESS):e-this.rollTotal>=10?X(this,de,Ee).call(this,ce.CRITICAL_FAILURE):this.rollTotal>=e?X(this,de,Ee).call(this,ce.SUCCESS):X(this,de,Ee).call(this,ce.FAILURE)},"#calculateDegreeOfSuccess"),Te(ne,"CRITICAL_FAILURE",0),Te(ne,"FAILURE",1),Te(ne,"SUCCESS",2),Te(ne,"CRITICAL_SUCCESS",3);var Ve={LOWER_BY_TWO:-2,LOWER:-1,INCREASE:1,INCREASE_BY_TWO:2,TO_CRITICAL_FAILURE:"criticalFailure",TO_FAILURE:"failure",TO_SUCCESS:"success",TO_CRITICAL_SUCCESS:"criticalSuccess"};var qt=["criticalFailure","failure","success","criticalSuccess"];var Gi=["arcana","crafting","medicine","nature","occultism","religion","society"],Vt={0:{icon:'<i class="fa-solid fa-xmark-large"></i><i class="fa-solid fa-xmark-large"></i>',name:"criticalFailure"},1:{icon:'<i class="fa-solid fa-xmark-large"></i>',name:"failure"},2:{icon:'<i class="fa-solid fa-check"></i>',name:"success"},3:{icon:'<i class="fa-solid fa-check"></i><i class="fa-solid fa-check"></i>',name:"criticalSuccess"}};async function Yt(t){let e=await new Roll("1d20").evaluate({async:!0}),n=e.dice[0].total,i=n===1?"0":n===20?"3":"",s=Object.values(t.skills).filter(l=>l.lore),a=Ke(l=>l.actor?.identificationDCs)?.actor,r={dieSuccess:i,dieResult:n,target:a,i18n:l=>C(`actions.recall-knowledge.${l}`)};if(a){let{standard:l,skills:f,lore:d}=a.identificationDCs,p=l.progression.slice();p.length=4,p=[...p];let g=d.map(({progression:h})=>{let m=h;return m.length=6,[...m]});r.skillsDCs=p,r.loresDCs=g,r.skills=await Promise.all(f.map(h=>{let m=t.skills[h];return rt(m,n,p)})),r.lores=await Promise.all(s.map(h=>rt(h,n)))}else r.skills=await Promise.all([...Gi.map(l=>t.skills[l]),...s].map(l=>rt(l,n)));let c=k("rk-dice"),o={speaker:ChatMessage.getSpeaker({actor:t}),rollMode:CONST.DICE_ROLL_MODES.BLIND,type:CONST.CHAT_MESSAGE_TYPES.ROLL};c&&(o.rolls=[e],r.rkDice=!0),o.flavor=await renderTemplate(N("chat/recall-knowledge"),r),ChatMessage.create(o)}u(Yt,"rollRecallKnowledges");async function rt(t,e,n){let{rank:i,label:s}=t,a=await t.roll({createMessage:!1,skipDialog:!0,extraRollOptions:["action:recall-knowledge"]}),r=a.total-a.dice[0].total,c=e+r;return{mod:r,rank:i,label:s,total:c,modifier:Q(r),rankLabel:ze[i],checks:n?.map(o=>{if(!o)return"-";let l=new ne(a,o).value;return{success:l,icon:Vt[l].icon,title:Vt[l].name}})}}u(rt,"rollSkill");var se="pf2e-token-hud",qi="Compendium.pf2e.feats-srd.Item.9jGaBxLUtevZYcZO",Ki=new Set(["Compendium.pf2e.equipment-srd.Item.44F1mfJei4GY8f2X","Compendium.pf2e.equipment-srd.Item.4kz3vhkKPUuXBpxk"]),Qt="Compendium.pf2e.feats-srd.Item.0GF2j54roPFIDmXf",Wi="Compendium.pf2e.feats-srd.Item.WC4xLBGmBsdOdHWu",ct="Compendium.pf2e.other-effects.Item.VCSpuc3Tf3XWMkd3",Vi={initiative:"PF2E.InitiativeLabel","recall-knowledge":"PF2E.RecallKnowledge.Label","cover-tracks":"PF2E.TravelSpeed.ExplorationActivities.CoverTracks",earnIncome:`${se}.skills.actions.earnIncome`,treatWounds:`${se}.skills.actions.treatWounds`,"borrow-arcane-spell":`${se}.skills.actions.borrow-arcane-spell`,"identify-magic":`${se}.skills.actions.identify-magic`,"identify-alchemy":`${se}.skills.actions.identify-alchemy`,"crafting-goods":`${se}.skills.actions.crafting-goods`,"staging-performance":`${se}.skills.actions.staging-performance`},Xt={aid:"Compendium.pf2e.actionspf2e.Item.HCl3pzVefiv9ZKQW","sense-motive":"Compendium.pf2e.actionspf2e.Item.1xRFPTFtWtGJ9ELw",seek:"Compendium.pf2e.actionspf2e.Item.BlAOM2X92SI6HMtJ",balance:"Compendium.pf2e.actionspf2e.Item.M76ycLAqHoAgbcej",escape:"Compendium.pf2e.actionspf2e.Item.SkZAQRkLLkmBQNB9","follow-the-expert":"Compendium.pf2e.actionspf2e.Item.tfa4Sh7wcxCEqL29","tumble-through":"Compendium.pf2e.actionspf2e.Item.21WIfSu7Xd7uKqV8","maneuver-in-flight":"Compendium.pf2e.actionspf2e.Item.Qf1ylAbdVi1rkc8M",squeeze:"Compendium.pf2e.actionspf2e.Item.kMcV8e5EZUxa6evt","recall-knowledge":"Compendium.pf2e.actionspf2e.Item.1OagaWtBpVXExToo","borrow-arcane-spell":"Compendium.pf2e.actionspf2e.Item.OizxuPb44g3eHPFh","decipher-writing":"Compendium.pf2e.actionspf2e.Item.d9gbpiQjChYDYA2L","identify-magic":"Compendium.pf2e.actionspf2e.Item.eReSHVEPCsdkSL4G","learn-a-spell":"Compendium.pf2e.actionspf2e.Item.Q5iIYCFdqJFM31GW",climb:"Compendium.pf2e.actionspf2e.Item.pprgrYQ1QnIDGZiy","force-open":"Compendium.pf2e.actionspf2e.Item.SjmKHgI7a5Z9JzBx",grapple:"Compendium.pf2e.actionspf2e.Item.PMbdMWc2QroouFGD","high-jump":"Compendium.pf2e.actionspf2e.Item.2HJ4yuEFY1Cast4h","long-jump":"Compendium.pf2e.actionspf2e.Item.JUvAvruz7yRQXfz2",reposition:"Compendium.pf2e.actionspf2e.Item.lOE4yjUnETTdaf2T",shove:"Compendium.pf2e.actionspf2e.Item.7blmbDrQFNfdT731",swim:"Compendium.pf2e.actionspf2e.Item.c8TGiZ48ygoSPofx",trip:"Compendium.pf2e.actionspf2e.Item.ge56Lu1xXVFYUnLP",disarm:"Compendium.pf2e.actionspf2e.Item.Dt6B1slsBy8ipJu9",repair:"Compendium.pf2e.actionspf2e.Item.bT3skovyLUtP22ME",craft:"Compendium.pf2e.actionspf2e.Item.rmwa3OyhTZ2i2AHl","crafting-goods":"",earnIncome:"Compendium.pf2e.actionspf2e.Item.QyzlsLrqM0EEwd7j","identify-alchemy":"Compendium.pf2e.actionspf2e.Item.Q4kdWVOf2ztIBFg1","create-a-diversion":"Compendium.pf2e.actionspf2e.Item.GkmbTGfg8KcgynOA",impersonate:"Compendium.pf2e.actionspf2e.Item.AJstokjdG6iDjVjE",lie:"Compendium.pf2e.actionspf2e.Item.ewwCglB7XOPLUz72",feint:"Compendium.pf2e.actionspf2e.Item.QNAVeNKtHA0EUw4X",bonMot:Qt,"gather-information":"Compendium.pf2e.actionspf2e.Item.plBGdZhqq5JBl1D8","make-an-impression":"Compendium.pf2e.actionspf2e.Item.OX4fy22hQgUHDr0q",request:"Compendium.pf2e.actionspf2e.Item.DCb62iCBrJXy0Ik6",coerce:"Compendium.pf2e.actionspf2e.Item.tHCqgwjtQtzNqVvd",demoralize:"Compendium.pf2e.actionspf2e.Item.2u915NdUyQan6uKF","administer-first-aid":"Compendium.pf2e.actionspf2e.Item.MHLuKy4nQO2Z4Am1","treat-disease":"Compendium.pf2e.actionspf2e.Item.TC7OcDa7JlWbqMaN","treat-poison":"Compendium.pf2e.actionspf2e.Item.KjoCEEmPGTeFE4hh",treatWounds:"Compendium.pf2e.actionspf2e.Item.1kGNdIIhuglAjIp9","command-an-animal":"Compendium.pf2e.actionspf2e.Item.q9nbyIF0PEBqMtYe",perform:"Compendium.pf2e.actionspf2e.Item.EEDElIyin4z60PXx","staging-performance":"",subsist:"Compendium.pf2e.actionspf2e.Item.49y9Ec4bDii8pcD3","create-forgery":"Compendium.pf2e.actionspf2e.Item.ftG89SjTSa9DYDOD","conceal-an-object":"Compendium.pf2e.actionspf2e.Item.qVNVSmsgpKFGk9hV",hide:"Compendium.pf2e.actionspf2e.Item.XMcnh4cSI32tljXa",sneak:"Compendium.pf2e.actionspf2e.Item.VMozDqMMuK5kpoX4","sense-direction":"Compendium.pf2e.actionspf2e.Item.fJImDBQfqfjKJOhk","cover-tracks":"Compendium.pf2e.actionspf2e.Item.SB7cMECVtE06kByk",track:"Compendium.pf2e.actionspf2e.Item.EA5vuSgJfiHH7plD","palm-an-object":"Compendium.pf2e.actionspf2e.Item.ijZ0DDFpMkWqaShd",steal:"Compendium.pf2e.actionspf2e.Item.RDXXE7wMrSPCLv5k","disable-device":"Compendium.pf2e.actionspf2e.Item.cYdz2grcOcRt4jk6","pick-a-lock":"Compendium.pf2e.actionspf2e.Item.2EE4aF4SZpYf0R6H"},Yi={escape:{slug:"escape",cost:"1",type:2,noSkill:!0},"recall-knowledge":{slug:"recall-knowledge",cost:"1",secret:!0},"decipher-writing":{slug:"decipher-writing",type:2,trained:!0},"identify-magic":{slug:"identify-magic",trained:!0},"learn-a-spell":{slug:"learn-a-spell",trained:!0}},De=[{slug:"perception",actions:[{slug:"sense-motive",cost:"1",type:2},{slug:"seek",cost:"1",type:2}]},{slug:"acrobatics",actions:[{slug:"balance",cost:"1",type:2},{slug:"tumble-through",cost:"1",type:2},{slug:"maneuver-in-flight",cost:"1",type:2,trained:!0},{slug:"squeeze",type:2,trained:!0}]},{slug:"arcana",actions:[{slug:"borrow-arcane-spell",trained:!0},"decipher-writing","identify-magic","learn-a-spell"]},{slug:"athletics",actions:[{slug:"climb",cost:"1",type:1},{slug:"force-open",cost:"1",type:1,map:!0,modifiers:[{condition:t=>!t.itemTypes.equipment.some(e=>e.isHeld&&Ki.has(e.sourceId)),modifiers:[{slug:"crowbar-missing",modifier:-2,type:"circumstance"}]}]},{slug:"grapple",cost:"1",type:1,map:!0,agile:!0},{slug:"high-jump",cost:"1",type:1},{slug:"long-jump",cost:"1",type:1},{slug:"reposition",cost:"1",type:2,map:!0,agile:!0},{slug:"shove",cost:"1",type:1,map:!0,agile:!0},{slug:"swim",cost:"1",type:1},{slug:"trip",cost:"1",type:2,map:!0,agile:!0},{slug:"disarm",cost:"1",type:1,map:!0,trained:!0,agile:!0}]},{slug:"crafting",actions:[{slug:"repair",type:1},{slug:"craft",type:1,trained:!0},{slug:"crafting-goods",trained:!0},{slug:"earnIncome",type:3,trained:!0},{slug:"identify-alchemy",trained:!0}]},{slug:"deception",actions:[{slug:"create-a-diversion",cost:"1",type:1,variants:["distracting-words","gesture","trick"]},{slug:"impersonate",type:1},{slug:"lie",type:1},{slug:"feint",cost:"1",type:1,trained:!0}]},{slug:"diplomacy",actions:[{slug:"bonMot",cost:"1",type:1,condition:t=>lt(t,Qt)},{slug:"gather-information",type:1},{slug:"make-an-impression",type:1},{slug:"request",cost:"1",type:1}]},{slug:"intimidation",actions:[{slug:"coerce",type:2},{slug:"demoralize",cost:"1",type:2}]},{slug:"medicine",actions:[{slug:"administer-first-aid",cost:"2",type:2,variants:["stabilize","stop-bleeding"],rollOption:"administer-first-aid"},{slug:"treat-disease",type:2,trained:!0},{slug:"treat-poison",cost:"1",type:2,trained:!0},{slug:"treatWounds",type:1,trained:!0}]},{slug:"nature",actions:[{slug:"command-an-animal",cost:"1",type:2},"identify-magic","learn-a-spell",{slug:"treatWounds",type:1,trained:!0,condition:t=>lt(t,Wi)}]},{slug:"occultism",actions:["decipher-writing","identify-magic","learn-a-spell"]},{slug:"performance",actions:[{slug:"perform",cost:"1",type:1,variants:["acting","comedy","dance","keyboards","oratory","percussion","singing","strings","winds"]},{slug:"staging-performance",trained:!0}]},{slug:"religion",actions:["decipher-writing","identify-magic","learn-a-spell"]},{slug:"society",actions:[{slug:"subsist",type:2},{slug:"create-forgery",type:2,trained:!0},"decipher-writing"]},{slug:"stealth",actions:[{slug:"conceal-an-object",cost:"1",type:2},{slug:"hide",cost:"1",type:2},{slug:"sneak",cost:"1",type:2}]},{slug:"survival",actions:[{slug:"sense-direction",type:1},{slug:"subsist",type:2},{slug:"cover-tracks",trained:!0},{slug:"track",type:1,trained:!0}]},{slug:"thievery",actions:[{slug:"palm-an-object",cost:"1",type:2},{slug:"steal",cost:"1",type:2},{slug:"disable-device",cost:"2",type:2,trained:!0},{slug:"pick-a-lock",cost:"2",type:2,trained:!0}]}];for(let t of De){t.actions=t.actions.map(i=>typeof i=="string"?Yi[i]:i);let{slug:e,actions:n}=t;for(let i of n){let s=i.slug.replace(/-(.)/g,(a,r)=>r.toUpperCase()).capitalize();if(i.skillSlug=e,i.uuid=Xt[i.slug],i.label=Vi[i.slug]??`PF2E.Actions.${s}.Title`,i.variants)i.variants=i.variants.map(a=>({slug:a,label:`${se}.skills.actions.${a}`}));else if(i.map){let a=!!i.agile;i.variants=[{label:"PF2E.Roll.Normal"},{label:"PF2E.MAPAbbreviationLabel",map:1,agile:a,mapValue:a?-4:-5},{label:"PF2E.MAPAbbreviationLabel",map:2,agile:a,mapValue:a?-8:-10}]}for(let{modifiers:a}of i.modifiers??[])for(let r of a)r.label=`${se}.skills.modifiers.${r.slug}`}}var ut=De.map(t=>t.slug),Qi=De.reduce((t,{slug:e,actions:n})=>(t[e]={slug:e,actions:n.reduce((i,s)=>(i[s.slug]=s,i),{})},t),{}),Jt=new Set(Object.values(Xt).filter(Boolean));function dt(t){return game.i18n.localize(t==="perception"?"PF2E.PerceptionLabel":CONFIG.PF2E.skillList[t])}u(dt,"getSkillLabel");async function Zt({actor:t,filter:e}){let n=[],i=t.isOfType("character"),s=i&&k("untrained")&&!t.itemTypes.feat.some(c=>c.sourceId===qi);for(let c=0;c<De.length;c++){let{slug:o,actions:l}=De[c],{label:f,rank:d,mod:p}=t.getStatistic(o),g=game.i18n.localize(f),h=l.filter(({condition:w,trained:I})=>(!s||!i||!I||t.skills[o].rank>=1)&&(!w||w(t))).map(w=>({...w,name:game.i18n.localize(w.label),variants:w.variants?.map(I=>({...I,name:game.i18n.localize(I.label)}))})),m=G(g,e),b=h;!m&&(b=h.filter(({name:w,variants:I})=>G(w,e)||I?.some(D=>G(D.name,e))),!b.length)||(n[c]={slug:o,name:g,rank:d,modifier:Q(p),actions:m?h:b})}n.sort((c,o)=>c.slug==="perception"?-1:o.slug==="perception"?1:j(c.name,o.name));let a=Object.values(t.skills).filter(({lore:c,label:o})=>c&&G(o,e)).map(({label:c,rank:o,mod:l,slug:f})=>({slug:f,label:c,rank:o,modifier:Q(l)})),r=a.reduce((c,o)=>o.modifier.length>c?o.modifier.length:c,2);return{contentData:{follow:C(`skills.actions.${ti(t)?"following":"follow"}`),skills:n,lores:a,loresModifierWidth:r},doubled:k("skills-columns")}}u(Zt,"getSkillsData");function ei({el:t,actor:e,token:n,hud:i}){t.find("[data-action=action-description]").on("click",s=>{s.preventDefault();let a=$(s.currentTarget).closest(".action");W(a,e,a.find(".name").children().html())}),e.isOwner&&(t.find("[data-action=follow-the-expert]").on("click",async s=>{s.preventDefault();let a=ti(e);if(a)return await a.delete();let r=(await fromUuid(ct)).toObject();setProperty(r,"flags.core.sourceId",ct),await e.createEmbeddedDocuments("Item",[r])}),t.find("[data-action=roll-skill]").on("click",s=>{s.preventDefault();let{slug:a}=s.currentTarget.dataset;e.getStatistic(a)?.roll({event:s}),k("skill-close")&&i.close()}),t.find("[data-action=roll-action]").on("click contextmenu",async s=>{s.preventDefault();let a=$(s.currentTarget),{skillSlug:r,slug:c,actionName:o}=a.closest(".action").data(),{variant:l,map:f,agile:d}=a.data(),p=s.type==="contextmenu"?await Je(o,{skill:r,agile:d}):void 0;p!==null&&(Xi({event:s,actor:e,token:n,skillSlug:r,slug:c,variant:l,map:f,skill:p?.skill,agile:p?.agile??d}),k("skill-close")&&i.close())}),t.find("[data-action=action-chat]").on("click",async s=>{s.preventDefault();let{uuid:a}=s.currentTarget.closest(".action").dataset,r=await fromUuid(a);r&&(We(s,r,e,{create:!0}),k("chat-close")&&i.close())}))}u(ei,"addSkillsListeners");function ti(t){return t.itemTypes.effect.find(e=>e.sourceId===ct)}u(ti,"isFollowingAnExpert");async function Je(t,{dc:e,agile:n,skill:i}={}){let s=ut.map(r=>({slug:r,label:dt(r)})),a=await renderTemplate(N("dialogs/variant"),{i18n:r=>C(`skills.variant.${r}`),dc:e,skill:i,agile:n,skills:s});return Dialog.prompt({title:t,label:C("skills.variant.button"),callback:r=>({skill:r.find("select").val(),dc:Number(r.find("[name=dc]").val()),agile:r.find("[name=agile]").is(":checked")}),rejectClose:!1,content:a,options:{width:280}})}u(Je,"variantsDialog");function pt(t,e){let n=t===1?e?-4:-5:e?-8:-10;return new game.pf2e.Modifier({label:"PF2E.MultipleAttackPenalty",modifier:n})}u(pt,"getMapModifier");function Xi({event:t,actor:e,skillSlug:n,slug:i,variant:s,map:a,agile:r,skill:c,token:o}){let l=Qi[n].actions[i],f=l.type===3?3:game.pf2e.actions.has(i)?2:i in game.pf2e.actions?1:void 0;c??=l.noSkill?void 0:n;let d=l.rollOption?[`action:${l.rollOption}`]:void 0;d&&s&&d.push(`action:${l.rollOption}:${s}`);let p={event:t,actors:[e],tokens:[o],variant:s,rollOptions:d,rollMode:l.secret?"blindroll":"roll"};if(p.modifiers=[],l.modifiers){for(let{condition:g,modifiers:h}of l.modifiers)if(!(g&&!g(e)))for(let m of h)p.modifiers.push(new game.pf2e.Modifier(m))}if(a){let g=pt(a,r);p.modifiers.push(g)}if(l.custom){l.custom(e,p);return}if(!f){e.getStatistic(c)?.roll(p);return}f===1?(p.skill=c,game.pf2e.actions[i](p)):f===2?(p.statistic=c,game.pf2e.actions.get(i).use(p)):f===3&&game.pf2e.actions[i](e)}u(Xi,"rollAction");var ft={aid:"Compendium.pf2e.actionspf2e.Item.HCl3pzVefiv9ZKQW",escape:"Compendium.pf2e.actionspf2e.Item.SkZAQRkLLkmBQNB9","recall-knowledge":"Compendium.pf2e.actionspf2e.Item.1OagaWtBpVXExToo","point-out":"Compendium.pf2e.actionspf2e.Item.sn2hIy1iIJX9Vpgj"};async function ii({actor:t,filter:e}){let n=t.system.initiative;return{contentData:{noMacro:C("extras.no-macro"),macros:Be(t)?.filter(i=>G(i.name,e)),initiative:n&&{selected:n.statistic,skills:ut.map(i=>({slug:i,label:dt(i)}))},hasDailies:game.modules.get("pf2e-dailies")?.active,hasPerception:game.modules.get("pf2e-perception")?.active,uuids:ft}}}u(ii,"getExtrasData");function ni({el:t,actor:e,token:n,hud:i}){function s(r,c,o="click"){t.find(`[data-action=${r}]`).on(o,l=>{l.preventDefault(),c(l)})}if(u(s,"action"),s("action-description",r=>{let c=$(r.currentTarget).closest(".row");W(c,e)}),!e.isOwner)return;J(t.find(".macro"));async function a(r){let{uuid:c}=r.currentTarget.closest(".macro").dataset;return fromUuid(c)}u(a,"getMacro"),s("delete-macro",r=>qe(r,e)),s("edit-macro",async r=>{(await a(r))?.sheet.render(!0)}),s("use-macro",async r=>{(await a(r))?.execute({actor:e,token:n}),k("macro-close")&&i.close()}),t.on("drop",r=>Ge(r,e)),s("action-chat",async r=>{let{uuid:c}=r.currentTarget.closest(".row").dataset,o=await fromUuid(c);o&&(We(r,o,e,{create:!0}),k("chat-close")&&i.close())}),t.find("input[name], select[name]").on("change",async r=>{let c=r.currentTarget,o=c.type==="number"?c.valueAsNumber:c.value;await e.update({[c.name]:o})}),s("roll-initiative",async r=>{await e.initiative.roll({event:r}),k("skill-close")&&i.close()}),s("prepare-dailies",r=>{let c=game.modules.get("pf2e-dailies");c?.active&&c.api.openDailiesInterface(e)}),s("rest-for-the-night",r=>{game.pf2e.actions.restForTheNight({actors:[e],tokens:[n]})}),s("roll-recall-knowledge",r=>{Yt(e),k("skill-close")&&i.close()}),s("roll-aid",async r=>{let c=await Je(game.i18n.localize("PF2E.Actions.Aid.Title"),{dc:15}),o={text:"@UUID[Compendium.pf2e.other-effects.Item.AHMUpMbaVkZ5A1KX]"};c!==null&&(game.pf2e.actions.get("aid").use({event:r,actors:[e],tokens:[n],statistic:c?.skill,difficultyClass:{value:c?.dc},notes:[o]}),k("skill-close")&&i.close())},"click contextmenu"),s("roll-point-out",r=>{game.pf2e.actions.get("point-out").use({event:r,actors:[e],tokens:[n]}),k("skill-close")&&i.close()}),s("roll-escape",async r=>{let c=$(r.currentTarget).data().map,o=r.type==="contextmenu"?await Je(game.i18n.localize("PF2E.Actions.Escape.Title"),{agile:c?!1:void 0}):void 0;if(o===null)return;let l=[];if(c){let f=o?.agile,d=pt(c,f);l.push(d)}game.pf2e.actions.get("escape").use({event:r,actors:[e],tokens:[n],statistic:o?.skill,modifiers:l}),k("skill-close")&&i.close()},"click contextmenu")}u(ni,"addExtrasListeners");var we={action:{order:0,label:"PF2E.ActionsActionsHeader",actionLabel:"PF2E.ActionTypeAction"},reaction:{order:1,label:"PF2E.ActionsReactionsHeader",actionLabel:"PF2E.ActionTypeReaction"},free:{order:2,label:"PF2E.ActionsFreeActionsHeader",actionLabel:"PF2E.ActionTypeFree"},passive:{order:3,label:"PF2E.NPC.PassivesLabel",actionLabel:"PF2E.ActionTypePassive"},exploration:{order:3,label:"PF2E.TravelSpeed.ExplorationActivity",actionLabel:"PF2E.TabActionsExplorationLabel"}};async function si({hud:t,actor:e,filter:n}){let i=e.isOfType("character"),s=k("actions"),a=(await mt()?.getStances(e))?.sort((m,b)=>j(m.name,b.name)),r=i?await pe()?.getHeroActions(e):void 0,c=r?e.heroPoints.value-r.length:void 0,o=e.isOwner,l=e.getRollData(),f=e.system.actions?await Promise.all(e.system.actions.map(async(m,b)=>({...m,index:b,visible:!i||m.visible,damageFormula:await m.damage?.({getFormula:!0}),criticalFormula:await m.critical?.({getFormula:!0}),description:m.description?await re(m.description,e,{rollData:l,isOwner:o}):void 0,altUsages:m.altUsages&&await Promise.all(m.altUsages.map(async w=>({...w,usage:w.item.isThrown?"thrown":"melee",damageFormula:await w.damage?.({getFormula:!0}),criticalFormula:await w.critical?.({getFormula:!0})})))}))):void 0,d=i?new game.pf2e.ElementalBlast(e):void 0,p=d?(await Promise.all(d.configs.map(async m=>{let b=m.damageTypes.find(I=>I.selected)?.value??"untyped",w=u((I,D=!0)=>d.damage({element:m.element,damageType:b,melee:D,outcome:I,getFormula:!0}),"formulaFor");return{...m,damageType:b,formula:{melee:{damage:await w("success"),critical:await w("criticalSuccess")},ranged:{damage:await w("success",!1),critical:await w("criticalSuccess",!1)}}}}))).sort((m,b)=>j(m.label,b.label)):void 0,g={},h=i?Zi(e,a):en(e);for(let m of h)G(m.name,n)&&(s!=="split"?(g.action??=[],g.action.push(m)):(g[m.type]??=[],g[m.type].push(m)));if(g=Object.entries(g).map(([m,b])=>{for(let w of b)w.img=xt(w.cost),w.typeLabel=we[w.type].actionLabel;return s!=="type"?b.sort((w,I)=>j(w.name,I.name)):b.sort((w,I)=>{let D=we[w.type].order,U=we[I.type].order;return D===U?j(w.name,I.name):D-U}),{type:m,actions:b,label:we[m].label}}),s==="split"&&g.sort((m,b)=>we[m.type].order-we[b.type].order),a?.length||f?.length||p?.length||g.length||r?.length){let m=+((a?.length??0)>0)+ +((f?.length??0)>0)+ +((p?.length??0)>0)+g.length+ +((r?.length??0)>0);return{contentData:{stances:a,strikes:f,blasts:p,sections:g,heroActions:r&&{actions:r,draw:Math.max(c,0),discard:Math.abs(Math.min(c,0)),canTrade:r.length&&Ji()},i18n:b=>C(`actions.${b}`),variantLabel:b=>b.replace(/.+\((.+)\)/,"$1"),damageTypes:CONFIG.PF2E.damageTypes},doubled:m>1&&k("actions-columns")}}}u(si,"getActionsData");function ai({el:t,actor:e,hud:n}){J(t.find(".toggle")),J(t.find(".strike")),J(t.find(".action"));function i(c,o,l="click"){let d=(typeof c=="string"?[c]:c).map(p=>`[data-action=${p}]`).join(", ");return t.find(d).on(l,p=>{p.preventDefault(),o(p)})}u(i,"action");function s(c){let o=c.currentTarget.closest(".strike"),l=e.system.actions[o.dataset.index];if(!l)return null;let{altUsage:f}=c.currentTarget.dataset;return["melee","thrown"].includes(f)?l.altUsages?.find(d=>f==="thrown"?d.item.isThrown:d.item.isMelee)??null:l}u(s,"getStrike");function a(c){return $(c.currentTarget).closest(".action").data().uuid}if(u(a,"getUuid"),i("action-description",async c=>{let o=$(c.currentTarget).closest(".action");W(o,e)}),i("hero-action-description",async c=>{let o=a(c),{description:l,name:f}=await pe()?.getHeroActionDetails(o)??{};l&&ue(f,l,e)}),i("strike-description",async c=>{let o=s(c);if(!o)return;let l=document.createElement("div");l.classList.add("description"),l.innerHTML=await renderTemplate(N("strike-description"),o),ue(o.label,l,e)}),i("blast-description",async c=>{let o=c.currentTarget.closest(".blast");W($(o),e)}),i("trait-description",c=>{let o=s(c);if(!o)return;let{index:l}=c.currentTarget.dataset,f=o.traits[l];if(!f)return;let d=game.i18n.localize(f.description);d&&ue(game.i18n.localize(f.label),d,e)}),i("stance-description",c=>{let o=$(c.currentTarget).closest(".action");W(o,e,o.data().itemName)}),!e.isOwner||(i("use-action",c=>{let o=B(c,e);o?.isOfType("action","feat")&&(zt(o,_e(c)),k("action-effect")&&tn(e,o),k("action-close")&&n.close())}),i("stance-chat",c=>{let o=B(c,e);o&&(o.toMessage(c,{create:!0}),k("chat-close")&&n.close())}),i("stance-toggle",c=>{let{effectUuid:o}=c.currentTarget.closest(".action").dataset;mt()?.toggleStance(e,o)}),i("exploration-toggle",c=>{let o=c.currentTarget.closest(".action").dataset.itemId,l=e.system.exploration.filter(f=>e.items.has(f));l.findSplice(f=>f===o)||l.push(o),e.update({"system.exploration":l})}),i("action-chat",c=>{let o=B(c,e);o&&(o.toMessage(c,{create:!0}),k("chat-close")&&n.close())}),i("hero-action-chat",async c=>{let o=pe();o&&(o.sendActionToChat(e,a(c)),k("chat-close")&&n.close())}),i("draw-hero-action",async c=>{await pe()?.drawHeroActions(e)}),i("use-hero-action",async c=>{let o=pe();o&&(o.useHeroAction(e,a(c)),k("action-close")&&n.close())}),i("discard-hero-action",async c=>{await pe()?.discardHeroActions(e,a(c))}),i("trade-hero-action",async c=>{pe()?.tradeHeroAction(e)}),i("strike-attack",c=>{let{index:o,altUsage:l}=c.currentTarget.dataset;s(c)?.variants[o].roll({event:c,altUsage:l}),k("attack-close")&&n.close()}),i(["strike-damage","strike-critical"],c=>{let{action:o}=c.currentTarget.dataset;s(c)?.[o==="strike-damage"?"damage":"critical"]({event:c}),k("attack-close")&&n.close()}),i("strike-auxiliary",c=>{if(c.currentTarget!==c.target)return;let o=s(c);if(!o)return;let{index:l}=c.currentTarget.dataset,f=c.currentTarget.querySelector("select")?.value??null;o.auxiliaryActions?.[l]?.execute({selection:f})}),i("toggle-versatile",c=>{let o=s(c)?.item;if(!o)return;let l=c.currentTarget,{value:f}=l.dataset,d=o?.system.damage.damageType??null,p=l.classList.contains("selected")||f===d?null:f;Gt({trait:"versatile",weapon:o,selection:p})}),i("strike-ammo",async c=>{let o=s(c)?.item;if(!o)return;let l=e.items.get(c.currentTarget.value);await o.update({system:{selectedAmmoId:l?.id??null}})},"change"),!e.isOfType("character")))return;let r=["roll-attack","roll-damage","set-damage-type"].map(c=>`[data-action=${c}]`).join(",");t.find(".blast").each((c,o)=>{let{element:l,damageType:f}=o.dataset,d=new game.pf2e.ElementalBlast(e);$(o).find(r).on("click",async p=>{p.preventDefault();let g=p.currentTarget.dataset,h=g.melee==="true";switch(g.action){case"roll-attack":{let m=Math.clamped(Number(g.mapIncreases),0,2);d.attack({mapIncreases:Math.clamped(m,0,2),element:l,damageType:f,melee:h,event:p});break}case"roll-damage":{d.damage({element:l,damageType:f,melee:h,outcome:g.outcome,event:p});break}case"set-damage-type":d.setDamageType({element:l,damageType:g.value})}["roll-attack","roll-damage"].includes(g.action)&&k("attack-close")&&n.close()})})}u(ai,"addActionsListeners");function oi(t){let e=game.modules.get("pf2e-toolbelt");return e?.active&&game.settings.get("pf2e-toolbelt",t)?e:void 0}u(oi,"getToolBeltModule");function ri(t){return oi(t)?.api}u(ri,"getToolBeltApi");function mt(){let t=game.modules.get("pf2e-stances");return t?.active?t.api:ri("stances")?.stances}u(mt,"getStancesModuleApi");function pe(){let t=game.modules.get("pf2e-hero-actions");return t?.active?t.api:ri("hero")?.heroActions}u(pe,"getHeroActionsApi");function Ji(){if(game.modules.get("pf2e-hero-actions")?.active)return game.settings.get("pf2e-hero-actions","trade");if(oi("hero"))return game.settings.get("pf2e-toolbelt","hero-trade")}u(Ji,"canTradeHeroActions");function Zi(t,e){let n=mt()?.getActionsUUIDS?.()??(e?.some(o=>o.actionUUID)?new Set(e.map(({actionUUID:o})=>o)):void 0)??new Set,i=new Set([...n,...Jt,...Object.values(ft)]),s=t.itemTypes.action,a=t.itemTypes.feat.filter(o=>o.actionCost),r=t.parties.size>0,c=t.system.exploration;return[...s,...a].map(o=>{let l=o.sourceId,f=o.id,d=o.actionCost,p=o.system.traits.value,g=p.includes("exploration");return{sourceId:l,id:f,type:d?.type??(g?"exploration":"free"),cost:d,name:o.name,isExploration:g,isDowntime:p.includes("downtime"),isActive:g&&c.includes(f),hasEffect:!!o.system.selfEffect}}).filter(o=>!o.isDowntime&&(r||!o.isExploration)&&(o.isExploration||!i.has(o.sourceId)))}u(Zi,"getCharacterActions");function en(t){return t.itemTypes.action.map(e=>{let n=e.actionCost,i=n?.type??"passive",s=i==="passive"&&(e.system.traits.value.includes("aura")||!!e.system.rules.find(a=>a.key==="Aura"));return{id:e.id,type:i,cost:n,name:e.name,hasDeathNote:e.system.deathNote,hasAura:s,hasEffect:!!e.system.selfEffect}})}u(en,"getNpcActions");async function tn(t,e){let n=e.system.selfEffect?.uuid;if(!n)return;let i=(await fromUuid(n))?.toObject();i&&t.createEmbeddedDocuments("Item",[i])}u(tn,"applyActionEffect");async function ci({actor:t}){let{system:e}=t,{details:n,traits:i,attributes:s}=e,{stealth:a}=s,{description:r,disable:c,routine:o,reset:l,isComplex:f}=n,d=t.getRollData(),p=t.isOwner,g=u(async h=>re(h,t,{isOwner:p,rollData:d}),"enrich");return{contentData:{description:await g(r),disable:await g(c),routine:await g(o),reset:await g(l),isComplex:f,rarity:{value:i.rarity,label:CONFIG.PF2E.rarityTraits[i.rarity]},traits:i.value.map(h=>CONFIG.PF2E.hazardTraits[h]),stealth:Q(a.value)},style:{"--max-width":`${k("hazard-width")}em`}}}u(ci,"getHazardData");function li({el:t,actor:e}){t.find("[data-action=action-description]").on("click",n=>{n.preventDefault();let i=$(n.currentTarget).closest(".action");W(i,e)}),ee.listen(t[0],e),e.isOwner&&t.find("[data-action=roll-initiative").on("click",n=>{n.preventDefault(),e.initiative.roll({event:n})})}u(li,"addHazardListeners");var di=new Set(["arcane","divine","occult","primal"]);function nn(t){return t.traits.has("cursed")?"unique":t.rarity}u(nn,"getDcRarity");function sn(t){let e=t.system.traits.value;return new Set(e.filter(n=>Lt(di,n)))}u(sn,"getMagicTraditions");function an(t,e,n){let i={occult:e,primal:e,divine:e,arcane:e},s=sn(t);for(let a of di)s.size>0&&!s.has(a)&&(i[a]=e+n);return{arcana:i.arcane,nature:i.primal,religion:i.divine,occultism:i.occult}}u(an,"getIdentifyMagicDCs");function on(t,{pwol:e=!1,notMatchingTraditionModifier:n}){let i=$e(t.level,{pwol:e}),s=nn(t),a=Ne(i,s);return t.isMagical?an(t,a,n):t.isAlchemical?{crafting:a}:{dc:a}}u(on,"getItemIdentificationDCs");var Ae=class extends FormApplication{static get defaultOptions(){return{...FormApplication.defaultOptions,id:"identify-item",title:game.i18n.localize("PF2E.identification.Identify"),template:"systems/pf2e/templates/actors/identify-item.hbs",width:"auto",classes:["identify-popup"]}}dcs=on(this.object,{pwol:game.pf2e.settings.variants.pwol.enabled,notMatchingTraditionModifier:game.settings.get("pf2e","identifyMagicNotMatchingTraditionModifier")});async getData(){let e=this.object;return{...await super.getData(),isMagic:e.isMagical,isAlchemical:e.isAlchemical,dcs:this.dcs}}activateListeners(e){let n=e[0],i=n.querySelector("button.update-identification");i?.addEventListener("click",()=>{this.submit({updateData:{status:i.value}})}),n.querySelector("button.post-skill-checks")?.addEventListener("click",async()=>{let s=this.object,a=s.system.identification.identified.name,r=this.dcs,c=s.isMagical?"identify-magic":s.isAlchemical?"identify-alchemy":null,o=await renderTemplate("systems/pf2e/templates/actors/identify-item-chat-skill-checks.hbs",{identifiedName:a,action:c,skills:Et(r,["dc"]),unidentified:s.system.identification.unidentified,uuid:s.uuid});await ChatMessage.implementation.create({user:game.user.id,content:o})})}async _updateObject(e,n){let i=n.status;if(i==="identified")return this.object.setIdentificationStatus(i)}};u(Ae,"IdentifyItemPopup");async function Oe({target:t,selected:e,direction:n="DOWN",onCreate:i,onDismiss:s,onClick:a,content:r,cssClass:c=[],locked:o=!1}){return new Promise(l=>{let f=`${A}-tooltip`,d=document.body.querySelectorAll(`.${f}:not(#tooltip)`);for(let p of d)xe(p);requestAnimationFrame(()=>{c=typeof c=="string"?[c]:c,e&&c.push("selection-tooltip"),Array.isArray(r)&&(r=r.map(({value:g,label:h})=>`<li><a ${g===e?'class="selected"':""} data-value="${g}">${h}</a></li>`).join(""));let p;if(r instanceof HTMLElement?p=r:(p=document.createElement("ul"),p.innerHTML=r),p.style.setProperty("--font-size",`${k("scale")}px`),c.length&&p.classList.add(...c.map(g=>`${A}-${g}`)),s&&new MutationObserver(function(){document.body.contains(p)||(s(),this.disconnect())}).observe(document.body,{childList:!0}),a){o=!0;for(let g of p.querySelectorAll("[data-value]"))g.addEventListener("click",async h=>{h.preventDefault();let m=h.currentTarget;xe(m),a?.(m.dataset.value)})}game.tooltip.activate(t,{content:p,direction:n,locked:o,cssClass:f}),i?.(p),l(p)})})}u(Oe,"createTooltip");function xe(t){let e=t.closest(`.${A}-tooltip`);game.tooltip.dismissLockedTooltip(e)}u(xe,"dismissTooltip");var Ze={weaponAndShield:{order:0,label:"PF2E.Actor.Inventory.Section.WeaponsAndShields"},armor:{order:1,label:"TYPES.Item.armor"},consumable:{order:2,label:"PF2E.Item.Consumable.Plural"},equipment:{order:3,label:"TYPES.Item.equipment"},treasure:{order:4,label:"TYPES.Item.treasure"},backpack:{order:5,label:"PF2E.Item.Container.Plural"}};async function pi({actor:t,filter:e}){let{contents:n,coins:i,totalWealth:s,bulk:a,invested:r}=t.inventory,c=t.isOfType("creature"),o=k("containers")||(te(t,`containers.${game.user.id}`)??[]),l={},f={};for(let d of n){let p=d.type==="shield"||d.type==="weapon"?"weaponAndShield":d.type;if(!Ze[p])continue;let g=d.system.containerId;p!=="backpack"&&g&&(o===!0||o.includes(g))?(l[g]??=[],l[g].push(d)):(f[p]??=[],f[p].push(d))}if(f=Object.entries(f).map(([d,p])=>{if(p.sort((g,h)=>j(g.name,h.name)),d==="backpack")for(let g=p.length-1;g>=0;g--){let h=p[g],m=l[h.id]?.filter(b=>G(b.name,e));if(!m?.length){G(h.name,e)||p.splice(g,1);continue}m.sort((b,w)=>j(b.name,w.name)),p.splice(g+1,0,...m)}else p=p.filter(g=>G(g.name,e));return{type:d,items:p,label:Ze[d].label}}).filter(d=>d.items.length).sort((d,p)=>Ze[d.type].order-Ze[p.type].order),f.length)return{doubled:f.length>1&&k("items-columns"),contentData:{canCarry:!!t.changeCarryType,categories:f,bulk:a,containers:o,i18n:d=>C(`items.${d}`),invested:r?`${game.i18n.localize("PF2E.InvestedLabel")}: ${r.value} / ${r.max}`:"",wealth:{coins:i.goldValue,total:s.goldValue},canUseItem:d=>c&&d.isOfType("consumable")&&d.isIdentified&&d.uses.max&&!d.isAmmo,itemDisabled:d=>!d.quantity||!d.uses.value||d.system.equipped.carryType==="dropped",isInContainer:(d,p)=>d.type!=="backpack"?!1:!p.isOfType("backpack")&&p.isInContainer}}}u(pi,"getItemsData");function fi({el:t,actor:e,token:n,hud:i}){let s=t.find(".item");J(s),s.find("[data-action=item-description]").on("click",async a=>{a.preventDefault();let r=$(a.currentTarget).closest(".item");await W(r,e)}),s.find("[data-action=toggle-contains-items]").on("click",async a=>{a.preventDefault();let r=`containers.${game.user.id}`,c=a.currentTarget.closest(".item").dataset.itemId,o=te(e,r)?.slice()??[],l=o.indexOf(c);l===-1?o.push(c):o.splice(l,1),await le(e,r,o)}),e.isOwner&&(s.find("[data-action=use-item]").on("click",a=>{let r=B(a,e);r&&(r.consume(),k("use-close")&&i.close())}),s.find("[data-action=item-chat]").on("click",async a=>{let r=B(a,e);r&&(r.toMessage(a,{create:!0}),k("chat-close")&&i.close())}),s.on("dragstart",a=>{let r=a.target.closest(".item"),{itemType:c,uuid:o}=r.dataset,l=new Image;l.src=r.querySelector(".item-img img").src,l.style.width="32px",l.style.height="32px",l.style.borderRadius="4px",l.style.position="absolute",l.style.left="-1000px",document.body.append(l),a.originalEvent.dataTransfer.setDragImage(l,16,16),a.originalEvent.dataTransfer.setData("text/plain",JSON.stringify({type:"Item",fromInventory:!0,itemType:c,uuid:o})),r.addEventListener("dragend",()=>l.remove(),{once:!0})}),t.find(".quantity input").on("change",async a=>{await B(a,e)?.update({"system.quantity":a.currentTarget.valueAsNumber})}),t.find("[data-action=toggle-item-invest]").on("click",a=>{a.preventDefault();let{itemId:r}=a.currentTarget.closest(".item").dataset;e.toggleInvested(r)}),t.find("[data-action=repair-item]").on("click",a=>{a.preventDefault();let r=B(a,e);r&&game.pf2e.actions.repair({item:r,actors:[e],tokens:[n]})}),t.find("[data-action=toggle-identified]").on("click",a=>{a.preventDefault();let r=B(a,e);r&&(r.isIdentified?r.setIdentificationStatus("unidentified"):new Ae(r).render(!0))}),t.find("[data-action=detach-item]").on("click",a=>{a.preventDefault();let{itemId:r,parentId:c}=a.currentTarget.closest("[data-item-id]").dataset,o=e.items.get(c);if(!o)return;let l=o.subitems.get(r);l&&Bt(l,a.ctrlKey)}),t.find("[data-action=edit-item]").on("click",a=>{a.preventDefault(),B(a,e)?.sheet.render(!0,{focus:!0})}),t.find("[data-action=delete-item]").on("click",a=>{a.preventDefault();let r=B(a,e);r&&(a.ctrlKey?r.delete():r.deleteDialog())}),t.find("[data-action=toggle-item-worn").on("click",async a=>{let r=B(a,e);if(!r)return;let c=document.createElement("div");c.innerHTML=await renderTemplate("systems/pf2e/templates/actors/partials/carry-type.hbs",{item:r});for(let o of c.querySelectorAll("[data-carry-type]"))o.addEventListener("click",async l=>{let f=l.currentTarget,d=f.dataset.carryType,p=Number(f.dataset.handsHeld)||0,g=f.dataset.inSlot!==void 0,h=r.system.equipped;xe(f),(d!==h.carryType||g!==h.inSlot||d==="held"&&p!==h.handsHeld)&&e.changeCarryType(r,{carryType:d,handsHeld:p,inSlot:g})});if(r.type!=="backpack"){let o=e.itemTypes.backpack.filter(l=>l.isIdentified);if(o.length){let l="";for(let d of o)l+='<li><a class="item-control item-location-option',d===r.container&&(l+=" selected"),l+=`" data-action="send-to-container" data-container-id="${d.id}">`,l+=`<i class="fas fa-box"></i>${d.name}</a></li>`;c.insertAdjacentHTML("beforeend",l);let f=c.querySelectorAll("[data-action=send-to-container]");for(let d of f)d.addEventListener("click",p=>{let g=p.currentTarget,h=g.dataset.containerId,m=e.items.get(h);m&&(xe(g),e.stowOrUnstow(r,m))})}}Oe({target:a.currentTarget,content:c,locked:!0,direction:"UP",selected:!0,cssClass:"carry-type"})}))}u(fi,"addItemsListeners");async function mi({actor:t,filter:e}){let n=t.system.resources.focus??{value:0,max:0},i=k("tradition"),s=game.modules.get("pf2e-staves")?.active,a=game.modules.get("pf2e-dailies"),r=a?.active,c=s||r&&isNewerVersion(a.version,"2.14.0"),o=s?"flags.pf2e-staves.charges":r?"flags.pf2e-dailies.staff.charges":"",l=[],f=[],d,p=!1,g=await Promise.all(t.spellcasting.collections.map(async h=>({entry:h.entry,data:await h.entry.getSheetData({spells:h})})));for(let{entry:h,data:m}of g){if(m.isRitual){d=m.groups.flatMap((E,q)=>E.active.map(({spell:L})=>{if(G(L.name,e))return{name:L.name,img:L.img,slotId:q,itemId:L.id,rank:L.rank,time:L.system.time.value}}).filter(Boolean));continue}let b=m.id,w=i&&m.statistic.label[0],I=m.isFocusPool,D=h.system?.prepared?.value==="charge",U=m.isInnate,x=m.isPrepared,Y=m.isSpontaneous,H=m.isFlexible,_=(()=>{if(m.category!=="items")return;let E=h.id.split("-")[0];return t.items.get(E)})(),F=(()=>{if(!D)return;let E=r&&a.api.getSpellcastingEntryStaffData(h),{charges:q,max:L,canPayCost:V}=E??getProperty(h,"flags.pf2e-staves.charges")??{charges:0,max:0};return{value:q,max:L,noMax:!0,canPayCost:V??(()=>!0)}})();for(let E of m.groups){if(!E.active.length||E.uses?.max===0)continue;let q=[],L=E.id==="cantrips",V=Mt(E.id);for(let Z=0;Z<E.active.length;Z++){let M=E.active[Z];if(!M||M.uses?.max===0)continue;let{spell:z,expended:ge,virtual:it,uses:he,castRank:nt}=M;G(z.name,e)&&q.push({name:z.name,img:z.img,tradition:w,castRank:nt??z.rank,slotId:Z,entryId:b,itemId:z.id,inputId:U?z.id:m.id,inputPath:_?"system.uses.value":D?o:U?"system.location.uses.value":`system.slots.slot${V}.value`,isCharge:D,isActiveCharge:D&&c,isVirtual:it,isInnate:U,isCantrip:L,isFocus:I,isPrepared:x,isSpontaneous:Y||H,groupId:E.id,consumable:_,uses:_?_.system.uses:D?F:he??E.uses,expended:D?!F.canPayCost(V):ge??(I&&!L?n.value<=0:!1),action:z.system.time.value,type:_?`PF2E.Item.Consumable.Category.${_.category}`:D?`${A}.spells.staff`:U?"PF2E.PreparationTypeInnate":Y?"PF2E.PreparationTypeSpontaneous":H?"PF2E.SpellFlexibleLabel":I?"PF2E.TraitFocus":"PF2E.SpellPreparedLabel",order:D?0:x?1:I?2:U?3:Y?4:5})}if(q.length){if(I)if(L)p=!0;else{f.push(...q);continue}l[V]??=[],l[V].push(...q)}}}if(l.length){let h=k("spells-sort"),m=h==="type"?(b,w)=>b.order===w.order?j(b.name,w.name):b.order-w.order:h==="entry"?(b,w)=>{let I=j(b.entryId,w.entryId);return I!==0?I:j(b.name,w.name)}:(b,w)=>j(b.name,w.name);for(let b of l)b&&b.sort(m)}if(f.length&&(f.sort((h,m)=>j(h.name,m.name)),l[12]=f,p=!1),l.length||d?.length){let h=gi(t),m=l.length+ +((d?.length??0)>0);return{contentData:{spells:l,rituals:d,focusPool:n,hasFocusCantrips:p,i18n:b=>C(`spells.${b}`),attackMod:hi(h)?h[0].mod:null,entryRank:b=>game.i18n.format("PF2E.Item.Spell.Rank.Ordinal",{rank:Ft(b)})},doubled:m>1&&k("spells-columns")}}}u(mi,"getSpellsData");function gi(t){return t.spellcasting.filter(e=>e.statistic).map(({statistic:e,name:n,id:i})=>({name:n,id:i,mod:Q(e.mod),statistic:e}))}u(gi,"getSpellAttacks");function hi(t){return new Set(t.map(({mod:e})=>e)).size===1}u(hi,"hasSingleSpellAttack");function yi({el:t,actor:e,hud:n}){J(t.find(".spell")),t.find("[data-action=spell-description]").on("click",async i=>{i.preventDefault();let s=$(i.currentTarget).closest(".spell");W(s,e)}),e.isOwner&&(t.find("[data-action=spell-attack]").on("click",async i=>{i.preventDefault();let s=gi(e);if(!s.length)return;let a;if(hi(s))a=s[0].statistic;else{let o=await Dialog.wait({buttons:{ok:{icon:'<i class="fa-solid fa-dice-d20"></i>',label:C("spells.attacks.ok"),callback:l=>l.find("input:checked").val()}},title:C("spells.attacks.title"),content:await renderTemplate(N("dialogs/spell-attacks"),{attacks:s}),close:()=>null});o&&(a=e.items.get(o)?.statistic)}let r=He(i,{type:"check"}),{map:c}=i.currentTarget.dataset;c&&(r.modifiers=[new game.pf2e.Modifier({label:"PF2E.MultipleAttackPenalty",modifier:Number(c)})]),a?.check.roll(r)}),t.find("[data-action=draw-item]").on("click",async i=>{i.preventDefault();let s=B(i,e);s&&e.changeCarryType(s,{carryType:"held",handsHeld:1})}),t.find("[data-action=spell-chat]").on("click",async i=>{i.preventDefault();let s=B(i,e);s&&(s.toMessage(i),k("chat-close")&&n.close())}),t.find("[data-action=toggle-pips]").on("click contextmenu",async i=>{i.preventDefault();let s=i.type==="click"?1:-1,a=(e.system.resources.focus?.value??0)+s;await e.update({"system.resources.focus.value":a})}),t.find("[data-action=toggle-prepared]").on("click",i=>{i.preventDefault();let{groupId:s,slotId:a,entryId:r,expended:c}=$(i.currentTarget).closest(".spell").data();e.spellcasting.collections.get(r)?.setSlotExpendedState(Rt(s),a||0,c!==!0)}),t.find("[data-action=cast-spell]").on("click",i=>{i.preventDefault();let{castRank:s,slotId:a,entryId:r,itemId:c}=i.currentTarget.closest(".spell").dataset,o=e.spellcasting.collections.get(r);if(!o)return;let l=o.get(c);if(!l)return;let f=Number(s)||NaN;Number.isInteger(f)&&f.between(1,10)&&(l.parentItem?.consume()||o.entry.cast(l,{rank:f,slotId:Number(a)})),k("cast-close")&&n.close()}),t.find("[data-input-path]").on("change",async i=>{let{inputPath:s,entryId:a}=$(i.currentTarget).data(),r=i.currentTarget.valueAsNumber;await e.updateEmbeddedDocuments("Item",[{_id:a,[s]:r}])}))}u(yi,"addSpellsListeners");var rn=["#combat-popout","#sidebar","#mini-tracker","#combat-dock","#combat-carousel","[id^=pf2e-perception]"].join(", "),cn={spells:"spellcasting",items:"inventory",skills:"proficiencies"},ki={left:["left","right","top","bottom"],right:["right","left","top","bottom"],top:["top","bottom","left","right"],bottom:["bottom","top","left","right"]},Le={opposition:{icon:"fa-solid fa-face-angry-horns",label:"PF2E.Actor.Creature.Alliance.Opposition"},party:{icon:"fa-solid fa-face-smile-halo",label:"PF2E.Actor.Creature.Alliance.Party"},neutral:{icon:"fa-solid fa-face-meh",label:"PF2E.Actor.Creature.Alliance.Neutral"}},ln=[{type:"land",icon:"fa-solid fa-shoe-prints"},{type:"burrow",icon:"fa-solid fa-chevrons-down"},{type:"climb",icon:"fa-solid fa-spider"},{type:"fly",icon:"fa-solid fa-feather"},{type:"swim",icon:"fa-solid fa-person-swimming"}],un={actions:{getData:si,addListeners:ai},items:{getData:pi,addListeners:fi},spells:{getData:mi,addListeners:yi},skills:{getData:Zt,addListeners:ei},extras:{getData:ii,addListeners:ni},hazard:{getData:ci,addListeners:li}},Pe={fortitude:{icon:"fa-solid fa-chess-rook",label:"PF2E.SavesFortitude"},reflex:{icon:"fa-solid fa-person-running",label:"PF2E.SavesReflex"},will:{icon:"fa-solid fa-brain",label:"PF2E.SavesWill"}},dn={perception:{icon:"fa-solid fa-eye",label:"PF2E.PerceptionLabel"},stealth:{icon:"fa-duotone fa-eye-slash",label:"PF2E.SkillStealth"},athletics:{icon:"fa-solid fa-hand-fist",label:"PF2E.SkillAthletics"}},Fe=class extends Application{#e=null;#d=null;#i=null;#a=null;#l=!1;#o=null;#u=[!1,!1,!1];#t=!1;#n=!1;#s=!1;#p;#r;#f;constructor(){super(),this.forceClose=()=>this.close({force:!0}),this.#p=(e,n)=>{n?this.#y(e):this.#k(e)},this.#r=e=>{let n=e.button;if(![0,2].includes(n))return;if(e.type==="mouseup"){this.#u[n]=!1;return}this.#u[n]=!0;let i=e.target,s=this.element[0];if(s){let a=s.querySelector(".popup");if(a&&!a.contains(i))if(!s.querySelector(".sidebar"))this.forceClose();else return a.remove();i.closest("canvas")&&this.forceClose();return}this.#g(),this.unlock(!0)},this.#f=e=>{this.#e&&e.id===this.#e.id&&this.forceClose()},window.addEventListener("mousedown",this.#r),window.addEventListener("mouseup",this.#r),Hooks.on("hoverToken",this.#p),Hooks.on("deleteToken",this.#f),Hooks.on("canvasPan",this.forceClose)}setToken(e,n){if(e!==this.#e){delete this.#e?.actor?.apps[this.appId],this.#e=e;let i=e?.actor;i&&(i.apps[this.appId]=this)}this.#s=n??this.#m(e)}setHolding(e){let n=k("key-holding");if(n!=="none"&&(this.#l=e,!(this.#n||this.#t)))if(e){if(!this.#i)return;let i=this.#m(this.#i);if(n==="half"&&!game.user.isGM&&!i){this.#g(),this.render();return}this.setToken(this.#i,i),this.render()}else n==="all"?this.close():game.user.isGM?(this.setToken(this.#i),this.render()):this.#s&&this.close()}#m(e){let n=e?.actor;if(!n)return!1;let i,s=n.system.details.alliance==="party";return game.user.isGM&&k("key-holding")==="half"&&!this.#l||n.isOfType("familiar")&&!n.master?i=!1:i=e.isOwner||k("observer")&&(e.observer||s&&k("party")),i}#y(e){if($(window.document).find(":hover").filter(rn).length)return;let n=e.actor;if(!n||n.isOfType("loot","party")||e.document.disposition===CONST.TOKEN_DISPOSITIONS.SECRET&&!n.isOwner||n.isOfType("npc")&&k("no-dead")&&n.isDead||(this.#i=e,e!==this.#d&&!this.#t&&this.close(),this.mousedown||this.#t||this.#n||e===this.#e))return;let i=k("key-holding"),s=this.#m(e);i!=="none"&&!this.#l&&(i==="all"||s)||(this.#b(!0),this.setToken(e,s),i==="none"||!this.#l?this.renderWithDelay():this.render())}#k(e){this.#i=null,!(this.mousedown||this.#t||this.#n)&&(this.#o=setTimeout(()=>{this.#o=null,!(this.#n||this.#t)&&this.close()},10))}renderWithDelay(){let e=k("delay");e?(e<10&&(e=10),this.#a=setTimeout(()=>{this.#a=null,this.render()},e)):this.render()}#b(e){this.#o!==null&&(clearTimeout(this.#o),this.#o=null,e&&this.close())}#g(){this.#a!==null&&(clearTimeout(this.#a),this.#a=null)}delete(){this.forceClose(),window.removeEventListener("mousedown",this.#r),window.removeEventListener("mouseup",this.#r),Hooks.off("hoverToken",this.#p),Hooks.off("deleteToken",this.#f),Hooks.off("canvasPan",this.forceClose)}static get defaultOptions(){return mergeObject(Application.defaultOptions,{popOut:!1,minimizable:!1,template:N("hud")})}get mousedown(){return this.#u[0]||this.#u[2]}get token(){return this.#e}get actor(){return this.#e?.actor}get hasCover(){return!!ot(this.actor)}get sidebar(){return this.element?.find("> .sidebar")??[]}get popup(){return this.element?.find("> .popup")??[]}get inner(){return this.element?.find("> .inner")??[]}async getData(){let e=this.#e,n=this.#e?.actor;if(!n)return{};let i=null,s=k("saves"),a=k("others"),r=n.isOfType("character"),{attributes:c}=n,{hp:o,ac:l}=c,f=o.sp??{max:0,value:0},d=game.settings.get("pf2e","staminaVariant"),p=k("distance"),g=k("scale");if(p==="all"||p==="self"&&this.#s){let v=k("unit").split(","),P=Number(v[0]?.trim())||1,O=v[1]?.trim()||game.system.gridUnits,S=Number(v[2]?.trim())||0,K=canvas.tokens.controlled,ae=!1,oe=K.length===1?K[0]:null;(!oe||oe===e)&&(oe=Ke(),ae=!0),oe&&oe!==e&&(i={unit:O,icon:ae?'<i class="fa-solid fa-crosshairs-simple"></i>':'<i class="fa-solid fa-expand"></i>',range:(e.distanceTo(oe)*P).toFixed(S)})}let h;if(!this.#s||k("see-status")){let v=k("status").split(",").map(P=>P.trim()).filter(Boolean);if(v.length&&o.max){let P=o.max+(d?f.max:0),O=o.value+(d?f.value:0),S=Math.clamped(O/P,0,1),K=(()=>{let ae=v.length;return k("last-status")?S===1?ae:Math.ceil(S*(ae-1)):Math.ceil(S*ae)})();h={hue:S*S*122+3,value:K===0?game.i18n.localize("EFFECT.StatusDead"):v.at(K-1)}}}let m={status:h,distance:i,fontSize:g,tokenId:e.id,type:n.isOfType("creature")?"creature":n.type};if(!this.#s||n.isOfType("familiar")&&!n.master)return m;let{level:b,saves:w,isOwner:I,system:D,itemTypes:U}=n,{resistances:x,weaknesses:Y,immunities:H}=c;if(m={...m,isOwner:I,isObserver:this.#s,name:e.document.name,hp:o,level:b},n.isOfType("army")){let v="Vqp8b64uH35zkncy",O=(await game.packs.get("pf2e.kingmaker-features")?.getDocuments({type:"campaignFeature"})??[]).filter(S=>S instanceof Item&&S.isOfType("campaignFeature"));return m={...m,basicWarActions:O.filter(S=>S.system.category==="army-war-action"&&S.folder?.id===v).map(S=>new CONFIG.Item.documentClass(S.toObject(!0),{parent:this.actor})).filter(S=>S.isOfType("campaignFeature"))},m}m={...m,ac:l.value,hasActions:U.action.length||D.actions?.filter(v=>v.visible!==!1).length};let _=k("ranks");function F(v,P,O){let S=v.slug,K=P==="bonus"?Q(v.mod):v.dc.value;return{slug:S,value:K,label:O[S].label,icon:O[S].icon,rank:_&&ze[v.rank]}}u(F,"getStatistic");function E(v,P){if(!v.length)return"";let O=v.map(S=>st(S.label.replace("-"," ").titleCase())).join("");return P?`<li>${game.i18n.localize(P)}<ul>${O}</ul></li>`:O}if(u(E,"toIWR"),n.isOfType("hazard")){let{hardness:v,emitsSound:P,stealth:O}=c;return{...m,hardness:v,emitsSound:P.toString().capitalize(),immunities:E(H),weaknesses:E(Y),resistances:E(x),stealth:{value:O.value,details:await re(O.details,n)},saves:s!=="none"&&["fortitude","reflex","will"].map(S=>{let K=w[S];return K?F(K,s,Pe):{slug:S,label:Pe[S].label,icon:Pe[S].icon}})}}if(m={...m,sidebarTitles:{actions:`${A}.actions.title`,items:`${A}.items.title`,spells:`${A}.spells.title`,skills:`${A}.skills.title`,extras:`${A}.extras.title`},hasItems:n.inventory.size},n.isOfType("vehicle")){let{hardness:v,collisionDC:P,collisionDamage:O}=c,{details:S}=D,{crew:K,passengers:ae,pilotingCheck:oe,speed:xi}=S;return{...m,hardness:v,crew:K,passengers:ae,pilotingCheck:oe,speed:xi,collisionDC:P.value,collisionDamage:O.value,immunities:E(H),weaknesses:E(Y),resistances:E(x),fortitude:F(w.fortitude,s,Pe)}}let q=k("show-death"),{heroPoints:L}=n,{resources:V,perception:Z,details:M}=D,{wounded:z,dying:ge,shield:it,speed:he,adjustment:nt}=c;function st(v){return`<li>${v.trim()}</li>`}u(st,"toInfo");function Ei(v,P){return j(v,P)}u(Ei,"sort");let Di=M?.languages?.value.map(v=>game.i18n.localize(CONFIG.PF2E.languages[v])).filter(Boolean).sort(Ei).map(st).join(""),ve=ln.map(({type:v,icon:P},O)=>({index:O,icon:P,label:game.i18n.localize(CONFIG.PF2E.speedTypes[v]??"PF2E.SpeedTypesLand"),value:(O===0?he.total:he.otherSpeeds.find(S=>S.type===v)?.total)||0})),ht=te(n,`speeds.selected.${game.user.id}`),Ai=(()=>{let v=0;if(ht!==void 0)v=ht;else if(k("force-speed")||ve[0].value===0){let P={index:0,value:ve[0].value};v=ve.reduce((O,{value:S},K)=>S>O.value?{index:K,value:S}:O,P).index}return ve.splice(v,1)[0]})(),yt=ve.map(({value:v,label:P,index:O})=>`<li><a data-value="${O}">${P}: ${v}</a></li>`).join("");return he.details&&(yt+=`<li>${game.i18n.localize("PF2E.DetailsHeading")}: ${he.details}</li>`),{...m,sp:d?f:{max:0},hero:L,dying:ge,wounded:z,shield:it,resolve:V.resolve,adjustment:nt,alliance:Le[wi(n).alliance],isCharacter:r,showDeathLine:r&&(q==="always"||ge.value||z.value),digitalPips:k("pips"),hasCover:this.hasCover,saves:s!=="none"&&["fortitude","reflex","will"].map(v=>F(w[v],s,Pe)),others:a!=="none"&&["perception","stealth","athletics"].map(v=>F(n.getStatistic(v),a,dn)),speeds:{main:Ai,others:yt},iwr:E(H,"PF2E.ImmunitiesLabel")+E(Y,"PF2E.WeaknessesLabel")+E(x,"PF2E.ResistancesLabel"),senses:Z.senses.map(v=>v.label)?.map(st).join(""),languages:Di,hasSpells:n.spellcasting.some(v=>v.category!=="items"||v.id.endsWith("-casting")),hasNotes:!r&&(D.details.publicNotes||D.details.privateNotes&&I)}}close(e={}){this.setToken(null),this.unlock(!0),this.#n=!1,this.#g();let n=Application.RENDER_STATES;if(!e.force&&![n.RENDERED,n.ERROR].includes(this._state))return;this._state=n.CLOSING;let i=this.element;if(!i)return this._state=n.CLOSED,this._state;i.css({minHeight:0});for(let s of this.constructor._getInheritanceChain())Hooks.call(`close${s.name}`,this,i);i.remove(),this._element=null,this._state=n.CLOSED,delete ui.windows[this.appId]}async _render(e=!1,n={}){let i,s,a,r,c;if(this.#d===this.#e){let o=this.sidebar[0];if(o){i=o.dataset.type,s=o.scrollTop;let l=o.querySelector(".sidebar-header");l.classList.contains("show")&&(c=l.querySelector(" input").value.trim())}a=this.popup[0],a&&(r=a.scrollTop)}if(await super._render(e,n),ui.windows[this.appId]=this,i){let o=await this.#c(i,c);s>0&&o.scrollTop(s)}a&&(this.element.append(a),r>0&&(a.scrollTop=r)),this.#d=this.#e,this.inner.length&&k("autolock")==="render"&&this.lock()}render(){this.actor&&super.render(!0)}_injectHTML(e){$("body").append(e),this._element=e}setPosition(){let e=this.#e;if(!e)return;let n=this.element[0],i=e.worldTransform.a,s=n.getBoundingClientRect(),a=canvas.clientCoordinatesFromCanvas(e.document._source),r={x:a.x,y:a.y,width:e.hitArea.width*i,height:e.hitArea.height*i,get right(){return this.x+this.width},get bottom(){return this.y+this.height}},c,o=this.#s?ki[k("position")].slice():ki[k("small-position")].slice();for(;o.length&&!c;){let l=o.shift();l==="left"?(c={x:r.x-s.width,y:gt(s,r)},c.x<0&&(c=void 0)):l==="right"?(c={x:r.right,y:gt(s,r)},c.x+s.width>window.innerWidth&&(c=void 0)):l==="top"?(c={x:bi(s,r),y:r.y-s.height},c.y<0&&(c=void 0)):l==="bottom"&&(c={x:bi(s,r),y:r.bottom},c.y+s.height>window.innerHeight&&(c=void 0))}return c&&(n.style.left=`${c.x}px`,n.style.top=`${c.y}px`),c}lock(){this.#t=!0}unlock(e){!e&&(this.sidebar.length||k("autolock")!=="none")||(this.#t=!1)}activateListeners(e){let n=this.#e,i=n?.actor;if(!i)return;let s=n.isOwner,a=ChatMessage.implementation;k("tooltips")&&e.find(".inner [data-tooltip]").attr("data-tooltip",""),e.find("[data-action=show-notes").on("click",async o=>{o.preventDefault();let{publicNotes:l,privateNotes:f,blurb:d}=i.system.details,p=Object.keys(CONFIG.PF2E.creatureTraits),g=i.system.traits.value.filter(p.includes,p).map(m=>({label:game.i18n.localize(CONFIG.PF2E.creatureTraits[m])??m,description:game.i18n.localize(CONFIG.PF2E.traitsDescriptions[m])??""})),h=await renderTemplate(N("show-notes"),{traits:g,blurb:d.trim(),publicNotes:l.trim(),privateNotes:s&&f.trim()});ue(`${i.name} - ${game.i18n.localize("PF2E.NPC.NotesTab")}`,h,i)}),e.on("mousedown",()=>this.bringToTop()),e.on("mouseenter",()=>{e.find(".inner").length&&(k("autolock")==="hover"&&this.lock(),this.#n=!0)}),e.on("mouseleave",()=>{this.#n=!1,!(this.#t||this.#i)&&this.close()}),e.on("dragover",()=>{n.isOwner&&e.find("> .sidebar.extras").length&&!e.find("> .popup").length||(e.css("opacity",.1),e.css("pointerEvents","none"),window.addEventListener("dragend",()=>{e.css("opacity",1),e.css("pointerEvents","")},{once:!0}))});let r=e.find("[data-action=show-info]");(s?r.filter(":not(.speeds)"):r).on("click",o=>{let l=o.currentTarget,f=l.dataset.tooltipContent;l.classList.contains("stealth")?this.#h({content:f,event:o,direction:"DOWN"}):Oe({target:l,content:f,direction:"UP"})}),e.find("[data-action=open-sidebar]").on("click",this.#c.bind(this)),s&&(e.find("[data-action=toggle-adjustment]").on("click contextmenu",o=>{o.preventDefault();let l=o.type==="click"?"elite":"weak";i.applyAdjustment(i.system.attributes.adjustment===l?null:l)}),e.find("[data-action=toggle-alliance]").on("click",o=>{let{originalAlliance:l,defaultAlliance:f}=wi(i),d=[{value:"default",label:game.i18n.format("PF2E.Actor.Creature.Alliance.Default",{alliance:game.i18n.localize(Le[f].label)})},{value:"opposition",label:game.i18n.localize(Le.opposition.label)},{value:"party",label:game.i18n.localize(Le.party.label)},{value:"neutral",label:game.i18n.localize(Le.neutral.label)}];this.#h({content:d,event:o,selected:l,onClick:p=>{p==="default"?i.update({"system.details.-=alliance":!0}):i.update({"system.details.alliance":p==="neutral"?null:p})}})}),e.find("[data-action=collision-dc]").on("click",o=>{o.preventDefault();let l=i.system.attributes.collisionDC.value||15;a.create({content:`@Check[type:reflex|dc:${l}]`,speaker:a.getSpeaker({actor:i})})}),e.find("[data-action=collision-damage]").on("click",async o=>{o.preventDefault();let l=(i.system.attributes.collisionDamage.value||"1d6").trim();Number.isNaN(Number(l.at(-1)))||(l+="[bludgeoning]");let f=wt(),d=await new f(l).evaluate({async:!0});a.create({flavor:`<strong>${game.i18n.localize("PF2E.vehicle.collisionDamageLabel")}</strong>`,speaker:a.getSpeaker({actor:i}),type:CONST.CHAT_MESSAGE_TYPES.ROLL,sound:"sounds/dice.wav",rolls:[d]})}),e.find("input").on("change",async o=>{let l=o.currentTarget,f=l.valueAsNumber,d=l.name;l.blur(),d!=="shield.value"?await i.update({[d]:f}):await i.heldShield.update({"system.hp.value":f})}),e.find("[data-action=toggle-hero]").on("click contextmenu",o=>{o.preventDefault();let{max:l,value:f}=i.heroPoints,d=o.type==="click"?1:-1,p=Math.clamped(f+d,0,l);p!==f&&i.update({"system.resources.heroPoints.value":p})}),e.find("[data-action=raise-shield]").on("click",o=>{o.preventDefault(),game.pf2e.actions.raiseAShield({actors:[i],tokens:[n]})}),e.find("[data-action=take-cover]").on("click",async o=>{o.preventDefault();let l=ot(i);l?l.delete():game.pf2e.actions.get("take-cover").use({actors:[i],tokens:[n]})}),e.find("[data-action=roll-save]").on("click",o=>{o.preventDefault();let l=o.currentTarget.dataset.save;i.saves[l].roll({event:o})}),e.find("[data-action=roll-other]").on("click",o=>{o.preventDefault();let l=o.currentTarget.dataset.slug;if(l!=="athletics"){let{ctrlKey:f,metaKey:d,shiftKey:p}=o;o=new MouseEvent("click",{ctrlKey:!f,metaKey:d,shiftKey:p})}i.getStatistic(l)?.roll({event:o})}),e.find("[data-action=recovery-check]").on("click",o=>{o.preventDefault(),i.rollRecovery(o)}),e.find("[data-action=toggle-dying], [data-action=toggle-wounded]").on("click contextmenu",o=>{o.preventDefault();let l=o.currentTarget.dataset.action==="toggle-dying"?"dying":"wounded",f=i.system.attributes[l]?.max;f&&(o.type==="click"?i.increaseCondition(l,{max:f}):i.decreaseCondition(l))}),e.find("[data-action=use-resolve]").on("click",o=>{o.preventDefault(),bt(i)}),r.filter(".speeds").on("click",o=>{this.#h({event:o,content:o.currentTarget.dataset.tooltipContent,direction:"UP",onClick:l=>{le(i,`speeds.selected.${game.user.id}`,Number(l))}})}))}#h({content:e,event:n,onClick:i,selected:s,direction:a}){Oe({content:e,target:n.currentTarget,direction:a,selected:s,locked:!0,onCreate:()=>this.lock(),onClick:i,onDismiss:()=>this.unlock()})}async showFilter(){let e=this.sidebar;e.length&&(e.find(".sidebar-header").hasClass("show")||(e=await this.#c(e.data().type,"")),e.find(".sidebar-header").find("input").focus().select(),e.scrollTop(0))}async#c(e,n){let i=typeof e=="string"?e:e.currentTarget.dataset.type,s=this.element,a=this.sidebar,r=a[0]?.dataset.type;if(a.remove(),s.find("[data-action=open-sidebar]").removeClass("active"),r===i&&n===void 0){this.unlock();return}let c=this.#e,o=c.actor,l=n!==void 0||k("filter"),{getData:f,addListeners:d}=un[i],p=cn[i]??"actions",g=o.synthetics.toggles.filter(F=>F.placement===p),h=await f({hud:this,actor:o,token:c,filter:n?.toLowerCase()})??{};if(!h.contentData&&!l&&!g.length)return ui.notifications.warn(C(`${i}.empty`,{name:this.#e.name}));let m={...h.contentData??{},isGM:game.user.isGM,isCharacter:o.isOfType("character"),isOwner:o.isOwner,isCreature:o.isOfType("creature")};this.lock(),s.find(`[data-action=open-sidebar][data-type=${i}]`).addClass("active"),s=s[0];let b=h.classes??[];b.push(i),k("scrollbar")||b.push("no-scrollbar"),h.doubled&&b.push("doubled");let w=h.style??{};w["--max-height"]=k("height").trim()||"100%";let I=document.createElement("div");I.innerHTML=await renderTemplate(N("sidebar"),{classes:b.join(" "),style:Object.entries(w).map(([F,E])=>`${F}: ${E}`).join("; "),type:i,filter:n,filterLabel:C("filter"),showFilter:l,toggles:g,isOwner:o.isOwner,content:(await renderTemplate(N(`sidebars/${i}`),m)).trim()}),a=I.firstElementChild,s.append(a);let D=a.getBoundingClientRect(),U=s.getBoundingClientRect(),x;k("position")==="left"?(x=U.x-D.width,x<0&&(x=U.right)):(x=U.right,x+D.width>window.innerWidth&&(x=U.x-D.width));let H=parseInt(window.getComputedStyle(s).padding),_=gt(D,U,H);return a.style.left=`${x}px`,a.style.top=`${_}px`,a=$(a),a.find(".sidebar-header [data-action=sidebar-filter-clear]").on("click",F=>{F.preventDefault(),a.find(".sidebar-header [data-action=sidebar-filter]").val(""),this.#c(i,"")}),a.find(".sidebar-header [data-action=sidebar-filter]").on("keydown",F=>{F.key==="Enter"&&this.#c(i,F.currentTarget.value.trim())}),a.find(".sidebar-toggles [data-action]").on("change",F=>{let E=F.currentTarget.closest(".toggle"),{domain:q,option:L,itemId:V}=E.dataset,Z=E.querySelector("select")?.value??null;o.toggleRollOption(q,L,V??null,E.querySelector("input").checked,Z)}),d({el:a,actor:o,token:c,hud:this}),Hooks.callAll("renderHUDSidebar",i,a,this),a}};u(Fe,"HUD");function gt(t,e,n=0){let i=e.y+e.height/2-t.height/2;return i+t.height>window.innerHeight&&(i=window.innerHeight-t.height-n),i<0&&(i=n),i}u(gt,"postionFromTargetY");function bi(t,e){let n=e.x+e.width/2-t.width/2;return n+t.width>window.innerWidth&&(y=window.innerWidth-t.width),n<0&&(n=0),n}u(bi,"postionFromTargetX");function wi(t){let e=t._source.system.details?.alliance,n=e===null?"neutral":e??"default",i=t.hasPlayerOwner?"party":"opposition";return{defaultAlliance:i,originalAlliance:n,alliance:n==="default"?i:n}}u(wi,"getAlliance");var A="pf2e-token-hud",fe=null;function ie(t=!1){return t?fe?.element:fe}u(ie,"getHud");function et(t){t&&!fe?fe=new Fe:!t&&fe&&(fe.delete(),fe=null)}u(et,"enableModule");function k(t){return game.settings.get(A,t)}u(k,"getSetting");function C(...t){let e=t.at(-1),n=typeof e=="object",i=n?t.slice(0,-1):t;return i.unshift(A),game.i18n[n?"format":"localize"](i.join("."),e)}u(C,"localize");function lt(t,e){return t.itemTypes.feat.some(n=>n.sourceId===e)}u(lt,"hasFeat");function N(t){return`modules/${A}/templates/${t}.hbs`}u(N,"templatePath");function Q(t){return t>=0?`+${t}`:t}u(Q,"modifier");function te(t,e){return t.getFlag(A,e)}u(te,"getFlag");function le(t,e,n){return t.setFlag(A,e,n)}u(le,"setFlag");async function re(t,e,{isOwner:n=e.isOwner,rollData:i=e.getRollData()}={}){let s=t?.trim();return s?await TextEditor.enrichHTML(s,{async:!0,secrets:n,rollData:i}):""}u(re,"enrichHTML");function Ii(){Ti("hold",{onDown:()=>{k("key-holding")!=="none"&&ie()?.setHolding(!0)},onUp:()=>{ie()?.setHolding(!1)}}),Ti("filter",{onUp:()=>{ie()?.showFilter()},editable:[{key:"KeyQ",modifiers:["Control"]}]})}u(Ii,"registerKeybindings");function vi(t,e){return`${A}.keybinds.${t}.${e}`}u(vi,"path");function Ti(t,e={}){game.keybindings.register(A,t,{name:vi(t,"name"),hint:vi(t,"hint"),precedence:CONST.KEYBINDING_PRECEDENCE.PRIORITY,...e})}u(Ti,"register");function Si(){let t=game.data.users.find(n=>n._id===game.data.userId).role>=CONST.USER_ROLES.GAMEMASTER,e=["first","second","third","fourth"].map(n=>C(`settings.status.statuses.${n}`)).join(", ");T("status",String,e,{scope:"world"}),T("last-status",Boolean,!1,{scope:"world"}),T("party",Boolean,!1,{scope:"world"}),T("rk-dice",Boolean,!1,{scope:"world"}),T("enabled",Boolean,!0,{onChange:et}),T("position",String,"right",{choices:["left","right","top","bottom"]}),T("small-position",String,"top",{choices:["left","right","top","bottom"]}),T("delay",Number,250,{range:{min:0,max:2e3,step:50}}),T("scale",Number,14,{range:{min:10,max:30,step:1}}),T("key-holding",String,"none",{hint:me("key-holding",t?"choices.gm.hint":"choices.player.hint"),choices:{none:me("key-holding","choices.none"),half:me("key-holding",t?"choices.gm.half":"choices.player.half"),all:me("key-holding",t?"choices.gm.all":"choices.player.all")}}),T("autolock",String,"none",{choices:["none","hover","render"]}),T("chat-close",Boolean,!1),T("attack-close",Boolean,!1),T("action-close",Boolean,!1),T("cast-close",Boolean,!1),T("skill-close",Boolean,!1),T("macro-close",Boolean,!1),T("use-close",Boolean,!1),T("no-dead",Boolean,!1),T("observer",Boolean,!0),T("see-status",Boolean,!1),T("saves",String,"bonus",{choices:["none","bonus","dc"]}),T("others",String,"none",{choices:["none","bonus","dc"]}),T("ranks",Boolean,!1),T("show-death",String,"always",{choices:["none","always","only"]}),T("force-speed",Boolean,!1),T("tooltips",Boolean,!1),T("pips",Boolean,!1),T("distance",String,"all",{choices:["none","self","all"]}),T("unit",String,""),T("height",String,""),T("filter",Boolean,!1),T("scrollbar",Boolean,!0),T("hazard-width",Number,32,{range:{min:14,max:50,step:1}}),T("actions-columns",Boolean,!1),T("items-columns",Boolean,!1),T("spells-columns",Boolean,!1),T("skills-columns",Boolean,!1),T("actions",String,"split",{choices:["name","type","split"]}),T("action-effect",Boolean,!1),T("containers",Boolean,!1),T("spells-sort",String,"disabled",{choices:["disabled","type","entry"]}),T("tradition",Boolean,!1),T("untrained",Boolean,!0)}u(Si,"registerSettings");function Ci(t,e){let n=e.find(`.tab[data-tab=${A}]`);function i(s,a,r="h3"){let c=C(`menu.${a}`);n.find(`[name="${A}.${s}"]`).closest(".form-group").before(`<${r}>${c}</${r}>`)}u(i,"beforeGroup"),game.user.isGM&&i("enabled","client.header","h2"),i("saves","client.tooltip"),i("distance","client.distance"),i("height","client.sidebar"),i("actions","client.actions"),i("containers","client.items"),i("spells-sort","client.spells"),i("untrained","client.skills")}u(Ci,"renderSettingsConfig");function me(t,e){return`${A}.settings.${t}.${e}`}u(me,"path");function T(t,e,n,i={}){Array.isArray(i.choices)&&(i.choices=i.choices.reduce((s,a)=>(s[a]=me(t,`choices.${a}`),s),{})),game.settings.register(A,t,{name:me(t,"name"),hint:me(t,"hint"),scope:"client",config:!0,type:e,default:n,...i})}u(T,"register");Hooks.once("setup",async()=>{Si(),Ii(),await loadTemplates({creature:N("tooltips/creature"),hazard:N("tooltips/hazard"),vehicle:N("tooltips/vehicle"),army:N("tooltips/army")})});Hooks.once("ready",()=>{k("enabled")&&et(!0),game.modules.get("pf2e-token-hud").api={getHud:ie}});Hooks.on("renderSettingsConfig",Ci);Hooks.on("drawMeasuredTemplate",t=>{t.isPreview&&ie()?.close()});Hooks.on("getActorDirectoryEntryContext",(t,e)=>{e.unshift({icon:'<i class="fa-solid fa-code"></i>',name:`${A}.actor.macros.contextmenu`,condition:n=>{let{documentId:i}=n.data();return k("enabled")&&game.actors.get(i)?.isOwner},callback:n=>{let{documentId:i}=n.data();pn(i)}})});var tt=class extends Dialog{async getData(e={}){let n=super.getData(e);return typeof n.content=="function"&&(n.content=await n.content()),n}};u(tt,"DataDialog");function pn(t){let e=game.actors.get(t);if(!e)return;let n=new tt({title:`${e.name} - ${C("actor.macros.title")}`,content:async()=>{let i=Be(e)??[];return renderTemplate(N("dialogs/macros"),{macros:i,noMacro:C("extras.no-macro")})},buttons:{},render:i=>{e.apps[n.appId]=n,i.on("drop",s=>Ge(s,e)),i.find("[data-action=delete-macro]").on("click",s=>qe(s,e))},close:()=>{delete e.apps[n.appId]}},{height:"auto"}).render(!0)}u(pn,"openMacrosDialog");})();
//# sourceMappingURL=main.js.map
